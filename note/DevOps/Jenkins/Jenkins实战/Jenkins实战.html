<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins实战 | 肥小猪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="肥小猪的笔记">
    <meta name="author" content="zhuangjie">
    <meta name="keywords" content="小庄的博客 小庄的笔记 zhuangjie 庄杰">
    
    <link rel="preload" href="/assets/css/0.styles.83bfd168.css" as="style"><link rel="preload" href="/assets/js/app.5c666aae.js" as="script"><link rel="preload" href="/assets/js/2.f4acce4e.js" as="script"><link rel="preload" href="/assets/js/10.7d647c34.js" as="script"><link rel="prefetch" href="/assets/js/11.ea5229fb.js"><link rel="prefetch" href="/assets/js/12.b859755e.js"><link rel="prefetch" href="/assets/js/13.94d3b5a2.js"><link rel="prefetch" href="/assets/js/14.ed2f4480.js"><link rel="prefetch" href="/assets/js/15.b3e305e6.js"><link rel="prefetch" href="/assets/js/16.49f8a835.js"><link rel="prefetch" href="/assets/js/17.f4b4e831.js"><link rel="prefetch" href="/assets/js/18.582de590.js"><link rel="prefetch" href="/assets/js/19.c85bd795.js"><link rel="prefetch" href="/assets/js/20.92741434.js"><link rel="prefetch" href="/assets/js/21.b7c8497e.js"><link rel="prefetch" href="/assets/js/22.96b46a67.js"><link rel="prefetch" href="/assets/js/23.0bc030ab.js"><link rel="prefetch" href="/assets/js/24.87f04d87.js"><link rel="prefetch" href="/assets/js/25.0f54baf2.js"><link rel="prefetch" href="/assets/js/26.1c39a9d2.js"><link rel="prefetch" href="/assets/js/27.31d22914.js"><link rel="prefetch" href="/assets/js/28.fc7f7405.js"><link rel="prefetch" href="/assets/js/29.1e94a8cc.js"><link rel="prefetch" href="/assets/js/3.c8d9910f.js"><link rel="prefetch" href="/assets/js/30.61082fbd.js"><link rel="prefetch" href="/assets/js/31.9e80c088.js"><link rel="prefetch" href="/assets/js/32.8ef6a48c.js"><link rel="prefetch" href="/assets/js/33.3349c1af.js"><link rel="prefetch" href="/assets/js/34.14ace618.js"><link rel="prefetch" href="/assets/js/35.3dca7364.js"><link rel="prefetch" href="/assets/js/36.25d01ad8.js"><link rel="prefetch" href="/assets/js/37.4527c97e.js"><link rel="prefetch" href="/assets/js/38.30b3c9ab.js"><link rel="prefetch" href="/assets/js/39.6f6d8c82.js"><link rel="prefetch" href="/assets/js/4.c72729ae.js"><link rel="prefetch" href="/assets/js/40.6454dbfd.js"><link rel="prefetch" href="/assets/js/41.ba49a8db.js"><link rel="prefetch" href="/assets/js/42.2ec3f8ee.js"><link rel="prefetch" href="/assets/js/43.e40c89c6.js"><link rel="prefetch" href="/assets/js/44.3d45a7aa.js"><link rel="prefetch" href="/assets/js/45.2375de76.js"><link rel="prefetch" href="/assets/js/46.a4cfa405.js"><link rel="prefetch" href="/assets/js/47.ab954289.js"><link rel="prefetch" href="/assets/js/48.4b72016d.js"><link rel="prefetch" href="/assets/js/49.9d06f5f2.js"><link rel="prefetch" href="/assets/js/5.44547aad.js"><link rel="prefetch" href="/assets/js/50.8dc92268.js"><link rel="prefetch" href="/assets/js/51.59e6212e.js"><link rel="prefetch" href="/assets/js/52.adecc9a3.js"><link rel="prefetch" href="/assets/js/53.030d635f.js"><link rel="prefetch" href="/assets/js/54.52060cbc.js"><link rel="prefetch" href="/assets/js/6.18c29f84.js"><link rel="prefetch" href="/assets/js/7.6427b380.js"><link rel="prefetch" href="/assets/js/8.67154bc3.js"><link rel="prefetch" href="/assets/js/9.757fe49c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.83bfd168.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="肥小猪" class="logo"> <span class="site-name can-hide">肥小猪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/程序员的自身修养.html" class="nav-link">
  总览
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/程序员的自身修养.html" class="nav-link">
  总览
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Jenkins实战</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/DevOps/Jenkins/Jenkins%E5%AE%9E%E6%88%98/Jenkins%E5%AE%9E%E6%88%98.html#目录" class="sidebar-link">目录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins%E5%AE%9E%E6%88%98/Jenkins%E5%AE%9E%E6%88%98.html#【gitlab仓库-192-168-87-100】" class="sidebar-link">【GitLab仓库 192.168.87.100】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins%E5%AE%9E%E6%88%98/Jenkins%E5%AE%9E%E6%88%98.html#【jenkins安装-192-168-87-101】" class="sidebar-link">【Jenkins安装 192.168.87.101】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins%E5%AE%9E%E6%88%98/Jenkins%E5%AE%9E%E6%88%98.html#【harbor环境-192-168-87-102】" class="sidebar-link">【Harbor环境 192.168.87.102】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins%E5%AE%9E%E6%88%98/Jenkins%E5%AE%9E%E6%88%98.html#【web服务器-192-168-87-103】" class="sidebar-link">【Web服务器 192.168.87.103】</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jenkins实战"><a href="#jenkins实战" class="header-anchor">#</a> Jenkins实战</h1> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <ul><li><p><a href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%AE%9E%E6%88%98">持续集成实战</a></p> <ul><li><p><a href="#gitlab%E4%BB%93%E5%BA%93-19216887100">【GitLab仓库 192.168.87.100】</a></p></li> <li><p><a href="#jenkins%E5%AE%89%E8%A3%85-19216887101">【Jenkins安装 192.168.87.101】</a></p> <ul><li><ul><li><p><a href="#1%E9%85%8D%E7%BD%AEjenkins">1、配置Jenkins</a></p></li> <li><p><a href="#2%E5%88%9B%E5%BB%BA%E4%B8%8Egitlab%E7%9A%84%E5%85%B3%E8%81%94">2、创建与GitLab的关联</a></p></li> <li><p><a href="#3%E6%9E%84%E5%BB%BA%E6%B5%81%E6%B0%B4%E7%BA%BF%E7%8E%AF%E5%A2%83">3、构建流水线环境</a></p></li> <li><p><a href="#4extended-choice-parameter%E5%8F%82%E6%95%B0%E6%9E%84%E5%BB%BA">4、Extended Choice Parameter参数构建</a></p></li> <li><p><a href="#5%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">5、注意事项</a></p></li> <li><p><a href="#6%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5">6、代码审查</a></p></li> <li><p><a href="#sonar%E4%B8%8Ejenkins%E6%95%B4%E5%90%88">Sonar与Jenkins整合</a></p></li> <li><p><a href="#7%E7%BC%96%E8%AF%91%E6%89%93%E5%8C%85">7、编译打包</a></p></li> <li><p><a href="#8docker%E7%8E%AF%E5%A2%83">8、Docker环境</a></p></li> <li><p><a href="#9%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C">9、镜像制作</a></p></li></ul></li></ul></li> <li><p><a href="#harbor%E7%8E%AF%E5%A2%83-19216887102">【Harbor环境 192.168.87.102】</a></p> <ul><li><ul><li><p><a href="#%E9%A1%B9%E7%9B%AE%E4%B8%8E%E7%94%A8%E6%88%B7">【项目与用户】</a></p></li> <li><p><a href="#1%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0harbor">1、推送镜像到Harbor</a></p></li> <li><p><a href="#2%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E4%BB%8Eharbor">2、拉取镜像从Harbor</a></p></li></ul></li></ul></li> <li><p><a href="#web%E6%9C%8D%E5%8A%A1%E5%99%A8-19216887103">【Web服务器 192.168.87.103】</a></p> <ul><li><ul><li><p><a href="#1%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2">1、应用部署</a></p></li> <li><p><a href="#2%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84nginx">2、高可用的nginx</a></p></li></ul></li></ul></li></ul></li></ul> <h1 id="持续集成实战"><a href="#持续集成实战" class="header-anchor">#</a> 持续集成实战</h1> <h2 id="【gitlab仓库-192-168-87-100】"><a href="#【gitlab仓库-192-168-87-100】" class="header-anchor">#</a> 【GitLab仓库 192.168.87.100】</h2> <ol><li>安装相关依赖</li></ol> <p>yum -y install policycoreutils openssh-server openssh-clients postﬁx</p> <ol><li>启动ssh服务&amp;设置为开机启动</li></ol> <p>systemctl enable sshd &amp;&amp; sudo systemctl start sshd</p> <ol><li>设置postﬁx开机自启，并启动，postﬁx支持gitlab发信功能</li></ol> <p>yum install postfix
systemctl enable postﬁx &amp;&amp; systemctl start postﬁx</p> <ol><li>开放ssh以及http服务，然后重新加载防火墙列表</li></ol> <p>firewall-cmd --add-service=ssh --permanent
firewall-cmd --add-service=http --permanent
firewall-cmd --reload</p> <p>如果关闭防火墙就不需要做以上配置</p> <ol><li>下载gitlab包，并且安装在线下载安装包：</li></ol> <p>wget <a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x" title="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x" target="_blank" rel="noopener noreferrer">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 86_64.rpm</p> <ol><li>安装：</li></ol> <p>rpm -i gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm</p> <ol><li>修改gitlab配置</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> /etc/gitlab/gitlab.rb
<span class="token comment">###修改gitlab访问地址和端口，默认为80，我们改为82 </span>
<span class="token comment">#修改external_url 'http://192.168.87.100'</span>
<span class="token comment">#加入nginx['listen_port'] = 82</span>
</code></pre></div><ol><li>重载配置及启动gitlab</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>gitlab-ctl reconfigure
gitlab-ctl restart
</code></pre></div><ol><li>把端口添加到防火墙</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">82</span>/tcp <span class="token parameter variable">--permanent</span> 
firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre></div><p>启动成功后，看到以下修改管理员root密码的页面，修改密码后，然后登录即可
9. 卸载gitlab
[教程]<a href="https://www.cnblogs.com/peteremperor/p/10837551.html" title="https://www.cnblogs.com/peteremperor/p/10837551.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/peteremperor/p/10837551.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>10、使用：
先创建一个组，然后创建一个用户，在组中创建一个项目，为项目添加成员，切换到成员，进行日常开发！
<code>创建组后向组中加入成员</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16346538723901634653872219.png" alt=""></p> <h2 id="【jenkins安装-192-168-87-101】"><a href="#【jenkins安装-192-168-87-101】" class="header-anchor">#</a> 【Jenkins安装 192.168.87.101】</h2> <p>这里介绍两种方法，一种方法将最新版jenkins加入到yum源，另外一种是下载指定版本的rpm包</p> <p>1）安装JDK</p> <p>2）安装jenkins</p> <p>wget -O ：下载并以不同的文件名保存</p> <p>yum的repo中默认没有Jenkins，需要先将Jenkins存储库添加到yum repos，执行下面的命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#准备</span>
yum  <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> daemonize
<span class="token comment">#正式安装</span>
<span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
<span class="token function">rpm</span> <span class="token parameter variable">--import</span> https://pkg.jenkins.io/redhat-stable/jenkins.io.key
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> jenkins <span class="token comment">#默认安装最新的</span>
systemctl <span class="token builtin class-name">enable</span> jenkins  <span class="token comment">#开机自启</span>
<span class="token comment">#vim /etc/sysconfig/jenkins   #修改内容： JENKINS_USER=“root” JENKINS_PORT=“8888”</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span>  <span class="token string">&quot;s/JENKINS_PORT=<span class="token entity" title="\&quot;">\&quot;</span>8080<span class="token entity" title="\&quot;">\&quot;</span>/JENKINS_PORT=<span class="token entity" title="\&quot;">\&quot;</span>8888<span class="token entity" title="\&quot;">\&quot;</span>/&quot;</span> /etc/sysconfig/jenkins
<span class="token function">service</span> jenkins start  <span class="token comment">#启动</span>

<span class="token comment">#开放端口</span>
firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">8888</span>/tcp <span class="token parameter variable">--permanent</span>
firewall-cmd <span class="token parameter variable">--reload</span> <span class="token comment">#重载防火墙</span>

</code></pre></div><p>打开浏览器访问 <a href="http://192.168.87.101:8888" title="http://192.168.87.101:8888" target="_blank" rel="noopener noreferrer">http://192.168.87.101:8888<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_1、配置jenkins"><a href="#_1、配置jenkins" class="header-anchor">#</a> 1、配置Jenkins</h4> <p>创建一个管理员用户 -&gt;  实例配置  -&gt; 可以安装推荐的插件或另一种。</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345225884471634522588357.png" alt=""></p> <p>3）配置为国内插件下载地址：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>cd /var/lib/jenkins/updates
sed -i 's/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g' default.json
sed -i 's/http:\/\/www.google.com/https:\/\/www.baidu.com/g' default.json
</code></pre></div><p>Manage Plugins点击Advanced，把Update Site改为国内插件下载地址：</p> <p><a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json" title="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json" target="_blank" rel="noopener noreferrer">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Sumbit后，在浏览器输入： <a href="http://xn--101ip-fz1iv81h:8888/restart" title="http://101机器ip:8888/restart" target="_blank" rel="noopener noreferrer">http://101机器ip:8888/restart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，重启Jenkins</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627721279406-1627721279398.png" alt=""></p> <p>4）安装中文插件</p> <p>安装插件的插件后，会帮我们安装中文插件，如果没有搜索&quot;Chinese&quot;，安装</p> <h4 id="_2、创建与gitlab的关联"><a href="#_2、创建与gitlab的关联" class="header-anchor">#</a> 2、创建与GitLab的关联</h4> <p>以下步骤：使用普通凭证从gitlab上拉取代码 -&gt;  使用ssh凭证从gitlab上拉取代码</p> <p><code>实现在Jenkins上拉取Gitlab上的代码</code></p> <p>在Jenkins上安装Credentials Binding ,安装 Git插件 、在Jenkins服务器上安装git (yum install git -y  &amp;&amp; git --version)</p> <p>1、创建普通凭证</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626250522291-1626250522234.png" alt=""></p> <p><code>使用ssh凭证来拉取</code></p> <p>2、使用ssh-keygen生成ssh，打开/root/.ssh/下cat公钥  复制到gitlab设置中的ssh：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251665628-1626251665529.png" alt=""></p> <p>3、配置ssh凭证</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626252147796-1626252147756-image-20210714164202919.png" alt=""></p> <h4 id="_3、构建流水线环境"><a href="#_3、构建流水线环境" class="header-anchor">#</a> 3、构建流水线环境</h4> <p>流水线构建项目，构建项目由之前的流程式转为了脚本（Pipeline）,我们创建一个流水线项目后，我们只需编写/生成一个Pipeline 即可完成对项目的拉取、构建、部署等操作。</p> <p>以下步骤：安装插件（Pipeline，安装推荐的插件中包含）  -&gt; 进行项目构建脚本（Pipeline）书写  -&gt;  查看</p> <p><code>1、安装插件</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626419582840-1626419582796.png" alt=""></p> <h4 id="_4、extended-choice-parameter参数构建"><a href="#_4、extended-choice-parameter参数构建" class="header-anchor">#</a> 4、Extended Choice Parameter参数构建</h4> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345284507411634528450683.png" alt=""></p> <p>示例：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/163453960961759d3f8f4632c99f1cb0ca9307497e741.png" alt=""></p> <h4 id="_5、注意事项"><a href="#_5、注意事项" class="header-anchor">#</a> 5、注意事项</h4> <p>1)拉取代码时，Jenkins脚本中的git凭证是ssh</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345397889081634539788897.png" alt=""></p> <h4 id="_6、代码审查"><a href="#_6、代码审查" class="header-anchor">#</a> 6、代码审查</h4> <p><code>安装</code></p> <blockquote><p><strong>注意，sonar6.7版本需要一个mysql5.7的数据库，jdk1.8以上比如8.5</strong> ，然后再创建一个名为<code>sonar</code> 的数据库。然后再开始安装Sonar，启动后再开放端口且登录获取token ：</p></blockquote> <p>以下步骤：保证存在名为sonar的数据库 -&gt;  安装Conar  -&gt; 余下工作</p> <p><code>保证存在名为sonar的数据库</code></p> <p><code>安装Conar</code></p> <p>下载sonar压缩包： <a href="https://www.sonarqube.org/downloads/" title="https://www.sonarqube.org/downloads/" target="_blank" rel="noopener noreferrer">https://www.sonarqube.org/downloads/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-6.7.4.zip
yum <span class="token function">install</span> <span class="token function">unzip</span>
<span class="token function">unzip</span> sonarqube-6.7.4.zip <span class="token comment">#解压</span>
<span class="token function">mv</span> sonarqube-6.7.4/* /usr/local/ <span class="token comment">#移动文件</span>

<span class="token function">useradd</span> sonar <span class="token comment">#创建sonar用户，必须sonar用于启动，否则报错</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> sonar. /usr/local/sonarqube-6.7.4 <span class="token comment">#更改sonar目录及文件权限修改sonar配置文件</span>

<span class="token function">vim</span> /usr/local/sonarqube-6.7.4/conf/sonar.properties
<span class="token comment">#直接将下面粘贴到配置上去，而端口不作修改（默认9000）</span>

<span class="token assign-left variable">sonar.jdbc.username</span><span class="token operator">=</span>root
<span class="token assign-left variable">sonar.jdbc.password</span><span class="token operator">=</span><span class="token number">3333</span>  
<span class="token assign-left variable">sonar.jdbc.url</span><span class="token operator">=</span>jdbc:mysql://localhost:3306/sonar?useUnicode<span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">characterEncoding</span><span class="token operator">=</span>utf8<span class="token operator">&amp;</span><span class="token assign-left variable">rewriteBatchedStatements</span><span class="token operator">=</span>true<span class="token operator">&amp;</span>useConﬁgs<span class="token operator">=</span> maxPerformance<span class="token operator">&amp;</span><span class="token assign-left variable">useSSL</span><span class="token operator">=</span>false

<span class="token builtin class-name">cd</span> /usr/local/sonarqube-6.7.4

<span class="token comment">#su sonar 不能使用root用户启动！！！所以下面在root用户下使用如下使用启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh start <span class="token comment">#启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh status <span class="token comment">#查看状态</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh stop <span class="token comment">#停止</span>

<span class="token function">tail</span> <span class="token parameter variable">-f</span> logs/sonar.logs <span class="token comment">#查看日志访问sonar http://192.168.66.101:9000</span>
<span class="token comment">#开放端口</span>
firewall-cmd  <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">9000</span>/tcp <span class="token parameter variable">--permanent</span>
firewall-cmd <span class="token parameter variable">--reload</span>

</code></pre></div><p><code>余下工作</code></p> <p>2)登录：默认  admin/admin</p> <p>​	获取token:</p> <p>​	输入admin , 得到如下信息,需要摘取保存token</p> <p>​	admin: <strong>d6065dbc1e1cfcd3a9714614b16d6bd816246d29</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626709303395-1626709303372.png" alt=""></p> <h4 id="sonar与jenkins整合"><a href="#sonar与jenkins整合" class="header-anchor">#</a> Sonar与Jenkins整合</h4> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925229389-1626925229368.png" alt=""></p> <p><code>安装插件</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345655278061634565527688.png" alt=""></p> <p><code>在Jenkins安装Sonar-Scanner工具</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925200244-1626925200242-image-20210720211841704.png" alt=""></p> <p><code>Manage Jenkins-&gt;Global Tool Conﬁguration 添加一个凭证</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925096630-1626925096623-image-20210720211228770.png" alt=""></p> <p><code>在jenkins“系统配置”中，作如下配置</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925064354-1626925064346-image-20210720211416805.png" alt=""></p> <p><code>在项目Jenkins脚本中</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345668961331634566895867.png" alt=""></p> <h4 id="_7、编译打包"><a href="#_7、编译打包" class="header-anchor">#</a> 7、编译打包</h4> <p><code>环境准备</code></p> <p>需要确保，jenkin主机安装了jdk、maven（配置好阿里云镜像，然后再看下面）
2、Jenkins上配置</p> <p>配置1：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259189981-1626259189950.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259391664-1626259391644.png" alt=""></p> <p>配置2：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627725746059-1627725746011.png" alt=""></p> <p><code>对于公共模块</code></p> <p>我们需要将公共依赖进行安装，所以需要编辑项目根目录下 “Jenkinsfile”  脚本,加入“编译，安装公共子工程” 这个 阶段：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">&quot;3b3eca2f-e2d7-44e5-8e11-e98ee29953dc&quot;</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">&quot;git@192.168.87.133:zhuangjie/tensquare_back.git&quot;</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">&quot;*/${branch}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">doGenerateSubmoduleConfigurations</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">submoduleCfg</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">userRemoteConfigs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">&quot;${git_auth}&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;${git_url}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">&quot;&quot;</span>&quot;
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">&quot;&quot;</span>&quot;
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">&quot;mvn -f tensquare_common clean install&quot;</span>
   <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>然后在确保各个模块&quot;pom.xml&quot; 存在打包插件(父工程的该插件可以删除了)：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>父模块上传到服务</code></p> <p>这样就能确保依赖安装能完成了。下面我们就进行对可运行的微服务进行打包：</p> <p>因为zull这个模块时依赖了父模块，所以我们需要确保服务器的本地仓库有父工程：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/root/.m2/repository/com/tensquare
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># mv /home/zhuangjie/桌面/tensquare_parent/ ./</span>
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># ll</span>
drwxr-xr-x. <span class="token number">3</span> root      root      <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:18 tensquare_common
drwxrwxrwx. <span class="token number">3</span> zhuangjie zhuangjie <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:37 tensquare_parent
</code></pre></div><p>我们移动的文件目录：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549375224-1627549375170.png" alt=""></p> <p>然后再进行构建。这样我们在拉取的代码目录中就打包好了该模块的jar文件（测试jar可正常运行）。</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549978651-1627549978565.png" alt=""></p> <h4 id="_8、docker环境"><a href="#_8、docker环境" class="header-anchor">#</a> 8、Docker环境</h4> <p>简单一句话总结：Docker<strong>技术就是让我们更加高效轻松地将任何应用在</strong>Linux<strong>服务器部署和使用</strong></p> <p>`【Docker安装】``</p> <p>1）卸载旧版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum list installed <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">docker</span> <span class="token comment">#列出当前所有docker的包</span>
yum <span class="token parameter variable">-y</span> remove <span class="token function">docker</span>  <span class="token comment">#的包名称 卸载docker包</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/docker <span class="token comment">#删除docker的所有镜像和容器</span>
</code></pre></div><p>2）安装必要的软件包</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils  device-mapper-persistent-data  lvm2
</code></pre></div><p>3）设置下载的镜像仓库</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
<span class="token comment">#或使用加速镜像:  yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</code></pre></div><p>4）列出需要安装的版本列表</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum list docker-ce <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span>  
</code></pre></div><p>5）安装指定版本（这里使用18.0.1版本）</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce-18.06.1.ce
</code></pre></div><p>6）查看版本&amp;设置开机自启</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token parameter variable">-v</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span> <span class="token comment">#设置开机启动  </span>
systemctl is-enabled <span class="token function">docker</span>  <span class="token comment">#查看是否设置为开机自启</span>
</code></pre></div><p>7）启动Docker</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl start <span class="token function">docker</span> <span class="token comment">#启动</span>
</code></pre></div><p>8）添加阿里云镜像下载地址（除此还是拉取与推送的信任列表）</p> <p>vi /etc/docker/daemon.json</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span> 
  <span class="token property">&quot;registry-mirrors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://zydiol88.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>9）重启Docker</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>  
systemctl status <span class="token function">docker</span>  <span class="token comment">#查看docker状态</span>
</code></pre></div><p>离线安装方式请参考：<a href="https://www.cnblogs.com/kingsonfu/p/11576797.html" title="https://www.cnblogs.com/kingsonfu/p/11576797.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/kingsonfu/p/11576797.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>【docker命令】</code></p> <p>1）镜像命令：</p> <p>镜像：相当于应用的安装包，在Docker部署的任何应用都需要先构建成为镜像</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> search 镜像名称 <span class="token comment">#搜索镜像</span>
<span class="token function">docker</span> pull 镜像名称 <span class="token comment">#拉取镜像 示例：docker pull nginx</span>
<span class="token function">docker</span> images <span class="token comment">#查看本地所有镜像</span>
<span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> 镜像名称 <span class="token comment">#删除镜像(即使在运行)</span>
<span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> images <span class="token parameter variable">-qa</span><span class="token variable">)</span></span> <span class="token comment">#删除所有镜像</span>
</code></pre></div><p>2）容器命令</p> <p>容器：容器是由镜像创建而来。容器是Docker运行应用的载体，每个应用都分别运行在Docker的每个
容器中。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">-p</span> 对应宿主机那个端口:开放应用端口  镜像名称:标签 <span class="token comment">#运行容器（默认是前台运行），di:i是运行，d是后台;  -p是public的意思;</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token comment">#查看运行的容器</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token comment">#查询所有容器</span>

<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 容器ID/容器名称 /bin/bash <span class="token comment">#进入容器内部</span>
<span class="token function">docker</span> start/stop/restart 容器名称/ID <span class="token comment">#启动/停止/重启容器</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> 容器名称/ID <span class="token comment">#删除容器</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-q</span><span class="token variable">`</span></span> <span class="token comment">#删除所有容器</span>
<span class="token function">docker</span> logs <span class="token parameter variable">-f</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">--tail</span> 行数 容器名  <span class="token comment">#查看容器运行日志</span>
</code></pre></div><p><code>【镜像的制作】</code></p> <p>下面将 &quot;ttensquare_eureka_server-1.0-SNAPSHOT.jar&quot; enreka微服务制作成一个docker镜像</p> <p>1）上传Eureka的微服务jar包到linux
2）编写Dockerfile</p> <div class="language-bash extra-class"><pre class="language-bash"><code>FROM openjdk:8-jdk-alpine
ARG JAR_FILE
COPY <span class="token variable">${JAR_FILE}</span> app.jar
EXPOSE <span class="token number">10086</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">&quot;java&quot;</span>,<span class="token string">&quot;-jar&quot;</span>,<span class="token string">&quot;/app.jar&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>3）构建镜像</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> build --build-arg <span class="token assign-left variable">JAR_FILE</span><span class="token operator">=</span>tensquare_eureka_server-1.0-SNAPSHOT.jar <span class="token parameter variable">-t</span> eureka:v1 <span class="token builtin class-name">.</span>
</code></pre></div><p>4）查看镜像是否创建成功</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> images
</code></pre></div><p>5）创建容器</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-i</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>eureka <span class="token parameter variable">-p</span> <span class="token number">10086</span>:10086 eureka:v1
</code></pre></div><p>6）访问容器
<a href="http://192.168.66.101:10086" title="http://192.168.66.101:10086" target="_blank" rel="noopener noreferrer">http://192.168.66.101:10086<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_9、镜像制作"><a href="#_9、镜像制作" class="header-anchor">#</a> 9、镜像制作</h4> <p>在这个过程中不需要在Jenkins中安装插件来辅助，假如jenkins所在机器要向harbor机器推送容器，只需要jenkins对docker配置将harbor加入信任列表且能登录到Harbor服务器即可，Harbor能被登录成功即可！
而对于项目内部，需要加入&quot;Dockerfile&quot; 文件</p> <p>当程序在项目根目录下执行“mvn -f ${currentProjectName}  clean package dockerfile:build” 时，就会进行编译打包，制作成镜像！</p> <h2 id="【harbor环境-192-168-87-102】"><a href="#【harbor环境-192-168-87-102】" class="header-anchor">#</a> 【Harbor环境 192.168.87.102】</h2> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627212945189-1627212945174.png" alt=""></p> <p>简介：</p> <p>Harbor（港口，港湾）是一个用于存储和分发Docker镜像的企业级Registry服务器。
除了Harbor这个私有镜像仓库之外，还有Docker官方提供的Registry。相对Registry，Harbor具有很
多优势：</p> <ol><li><p>提供分层传输机制，优化网络传输 Docker镜像是是分层的，而如果每次传输都使用全量文件(所以
用FTP的方式并不适合)，显然不经济。必须提供识别分层传输的机制，以层的UUID为标识，确定
传输的对象。</p></li> <li><p>提供WEB界面，优化用户体验 只用镜像的名字来进行上传下载显然很不方便，需要有一个用户界
面可以支持登陆、搜索功能，包括区分公有、私有镜像。</p></li> <li><p>支持水平扩展集群 当有用户对镜像的上传下载操作集中在某服务器，需要对相应的访问压力作分
解。</p></li> <li><p>良好的安全机制 企业中的开发团队有很多不同的职位，对于不同的职位人员，分配不同的权限，
具有更好的安全性。</p></li></ol> <p>1）先安装Docker并启动Docker（已完成）</p> <p>参考之前的安装过程
2）先安装docker-compose</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">`</span></span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose  <span class="token comment">#安装</span>
<span class="token comment">#加速版 curl -L &quot;https://get.daocloud.io/docker/compose/releases/download/1.27.3/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose  
<span class="token function">docker-compose</span> <span class="token parameter variable">--version</span>  <span class="token comment">#查看版本</span>
</code></pre></div><p>3）下载Harbor的压缩包（本课程版本为：v1.9.2）
<a href="https://github.com/goharbor/harbor/releases" title="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener noreferrer">https://github.com/goharbor/harbor/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>4）安装开始</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">tar</span> <span class="token parameter variable">-xzf</span> harbor-offline-installer-v1.9.2.tgz <span class="token parameter variable">-C</span> /usr/local/
<span class="token builtin class-name">cd</span> /usr/local/harbor

<span class="token function">vim</span> harbor.yml
<span class="token comment">#修改内容1:   hostname: 192.168.87.102</span>
<span class="token comment">#修改内容2:   port: 85</span>
<span class="token comment">#还可以修改登录密码，这里不作配置，下面使用的是默认的密码进行登录</span>

./install.sh
<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> <span class="token comment">#启动</span>
<span class="token comment">#docker-compose down -v #停止</span>

</code></pre></div><p>5）添加为开机自启
vim /lib/systemd/system/harbor.service</p> <div class="language-shell= extra-class"><pre class="language-text"><code>[Unit]
Description=Harbor
After=docker.service systemd-networkd.service systemd-resolved.service
Requires=docker.service
Documentation=http://github.com/vmware/harbor

[Service]
Type=simple
Restart=on-failure
RestartSec=5
ExecStart=/usr/local/bin/docker-compose -f  /usr/local/harbor/docker-compose.yml up
ExecStop=/usr/local/bin/docker-compose -f /usr/local/harbor/docker-compose.yml down

[Install]
WantedBy=multi-user.target

</code></pre></div><p>systemctl enable harbor
systemctl is-enabled harbor</p> <p>8）访问Harbor
<a href="http://192.168.66.102:85" title="http://192.168.66.102:85" target="_blank" rel="noopener noreferrer">http://192.168.66.102:85<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
默认账户密码：admin/Harbor12345</p> <p>你可能会遇到的问题：<a href="https://www.cnblogs.com/hallejuayahaha/p/13926575.html" title="https://www.cnblogs.com/hallejuayahaha/p/13926575.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/hallejuayahaha/p/13926575.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> （参考）博主遇到了docker-compose过低找不到，导致启动报错：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>[root@localhost zhuangjie]# docker-compose up -d #启动
ERROR: 
        Can't find a suitable configuration file in this directory or any
        parent. Are you in the right directory?

        Supported filenames: docker-compose.yml, docker-compose.yaml
        
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#方法一重启</span>

<span class="token comment">#方法二：</span>
<span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">`</span></span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose
<span class="token function">docker-compose</span> <span class="token parameter variable">--version</span>

./install.sh <span class="token comment">#注意还要cd到Harbor根目录执行</span>
</code></pre></div><h4 id="【项目与用户】"><a href="#【项目与用户】" class="header-anchor">#</a> 【项目与用户】</h4> <p>登录后：</p> <p>1）创建私有项目（项目分为公开项目与私有项目）</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627218066729-1627218066687.png" alt=""></p> <p>2）创建用户</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217685972-1627217685963.png" alt=""></p> <p>3）为项目添加成员：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217922413-1627217922383.png" alt=""></p> <table><thead><tr><th>角色</th> <th>权限说明</th></tr></thead> <tbody><tr><td>访客</td> <td>对于指定项目拥有只读权限</td></tr> <tr><td>开发人员</td> <td>对于指定项目拥有读写权限</td></tr> <tr><td>维护人员</td> <td>对于指定项目拥有读写权限，创建 Webhooks</td></tr> <tr><td>项目管理员</td> <td>除了读写权限，同时拥有用户管理/镜像扫描等管理权限</td></tr></tbody></table> <h4 id="_1、推送镜像到harbor"><a href="#_1、推送镜像到harbor" class="header-anchor">#</a> 1、推送镜像到Harbor</h4> <p>1）给镜像打上标签</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> tag eureka:v1 <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1
</code></pre></div><p>2）推送镜像(会遇到二个问题，请解决)</p> <ol><li><p>问题1：需要把Harbor地址加入到Docker信任列表,不解决，推送会提示：
vi /etc/docker/daemon.json
需要重启Docker</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>The push refers to repository [192.168.66.102:85/tensquare/eureka]
Get https://192.168.66.102:85/v2/: http: server gave HTTP response to HTTPS
client
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span> 
 <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://zydiol88.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>,
 <span class="token string">&quot;insecure-registries&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;192.168.208.157:85&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>问题2：权限不足，不解决，推送会提示：“denied: requested access to the resource is denied”</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#docker login -u 用户名 -p 密码 192.168.66.102:85</span>

<span class="token punctuation">[</span>root@localhost 桌面<span class="token punctuation">]</span><span class="token comment"># docker login -u zhuangjie  -p gkmzjaznH21  192.168.87.102:85</span>
Login Succeeded
</code></pre></div></li> <li><p>推送</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> push <span class="token number">192.168</span>.208.157:85/uplog/eureka
</code></pre></div></li></ol> <p>3）登录Harbor查看</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627219857216-1627219857185.png" alt=""></p> <h4 id="_2、拉取镜像从harbor"><a href="#_2、拉取镜像从harbor" class="header-anchor">#</a> 2、拉取镜像从Harbor</h4> <p>存在Docker后，我们做以下准备，这样才能确保我们能从Harbor中拉取镜像：</p> <ol><li><p>需要把Harbor地址加入到Docker信任列表,不解决，推送会提示：
vi /etc/docker/daemon.json
需要重启Docker</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>The push refers to repository [192.168.66.102:85/tensquare/eureka]
Get https://192.168.66.102:85/v2/: http: server gave HTTP response to HTTPS
client
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span> 
 <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://zydiol88.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>,
 <span class="token string">&quot;insecure-registries&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;192.168.208.157:85&quot;</span><span class="token punctuation">]</span>  
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>准备拉取</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> login <span class="token parameter variable">-u</span> zhuangjie <span class="token parameter variable">-p</span> zhuangJIE3333 <span class="token number">192.168</span>.208.157:85  <span class="token comment">#登录</span>
<span class="token function">docker</span> pull <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1  <span class="token comment">#拉取，该拉取命令直接从Harbor上一键复制</span>
<span class="token function">docker</span> images  <span class="token comment">#查看本地镜像</span>
</code></pre></div></li></ol> <h2 id="【web服务器-192-168-87-103】"><a href="#【web服务器-192-168-87-103】" class="header-anchor">#</a> 【Web服务器 192.168.87.103】</h2> <h4 id="_1、应用部署"><a href="#_1、应用部署" class="header-anchor">#</a> 1、应用部署</h4> <p>分布式应用部署，我们需要再加入一台web服务器：
环境初始化：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>systemctl enable sshd &amp;&amp; sudo systemctl start sshd

firewall-cmd --add-service=ssh --permanent
firewall-cmd --add-service=http --permanent
firewall-cmd --reload
</code></pre></div><p>环境：必须安装jdk, docker（然后将harbor加入信任列表：），</p> <p>vi /etc/docker/daemon.json</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>{
 &quot;registry-mirrors&quot;: [&quot;https://zydiol88.mirror.aliyuncs.com&quot;],
 &quot;insecure-registries&quot;: [&quot;192.168.87.102:85&quot;]
}
</code></pre></div><p>sudo systemctl restart docker   #重启
systemctl status docker  #查看docker状态</p> <p>jenkins安装 “Publish over SSH” 插件，现在的问题是如何通过ssh控制一web服务器了。</p> <p>1）需要在jenkins服务器中执行  ssh-copy-id 192.168.87.104 到新的web的服务器，然后再到jenkins配置一下，就可以使用这个web服务器进行部署了</p> <p>2）在jenkins 的”全局配置“中配置&quot;Publish over SSH&quot; 的内容。怎么配置？</p> <p>【Passphrse】密码，好像没有设置，如果设置了，需要填写。
【Path to key】key文件的路径（私钥）/root/.ssh/id_rsa
【Key】为空，也 可以测试成功**。注意如果 “/root/.ssh/id_rsa” 文件找不到需要将.ssh的私钥粘贴到文本框中，至于是root还是其它用户，要看使用copy命令时用的是哪个用户执行的了。**</p> <p>【SSH Server Name】标识的名字，随便你取什么名字
【Hostname】需要连接ssh的主机名或ip地址，此处填写应用服务器IP（建议ip）
【Username】用户名
【Remote Directory】远程目录(根据需要填写文件传到此目录下)
【Test Configuration】配置完成，点击test会显示Success![]</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093028483-1628093028472.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628083784632-1628083784445.png" alt=""></p> <p>完整”Jenkinsfile“:</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>//git凭证ID
def git_auth = &quot;da1d1333-c35f-415a-903c-b8d58c870c56&quot;
//git的url地址
def git_url = &quot;git@192.168.87.100:zhuangjie/tensquare_back.git&quot;

//镜像的版本号
def tag = &quot;latest&quot;
//Harbor的url地址
def harbor_url = &quot;192.168.87.102:85&quot;
//镜像库项目名称
def harbor_project = &quot;uplog&quot;
//Harbor的登录凭证ID
def harbor_auth = &quot;ef2651c8-92a7-4edb-b4ca-4e182fadf0ca&quot;

node {
    //获取当前选择的项目名称
    def selectedProjectNames = &quot;${project_name}&quot;.split(&quot;,&quot;)
    //把选择的服务器信息转为数组
    def selectedServers = &quot;${publish_server}&quot;.split(',')

   stage('拉取代码') {
      checkout([$class: 'GitSCM', branches: [[name: &quot;*/${branch}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &quot;${git_auth}&quot;, url: &quot;${git_url}&quot;]]])
   }
   stage('代码审查') {
        for (int i=0; i&lt;selectedProjectNames.length; i++) {
            //tensquare_eureka_server@10086
            def projectInfo = selectedProjectNames[i];
            //当前遍历的项目名称
            def currentProjectName = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[0]
            //当前遍历的项目端口
            def currentProjectPort = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[1]
            def scannerHome=tool 'SonarQube-Scanner'//根据自己的Jenkinssonarqube-scanner环境修改
            withSonarQubeEnv('SonarQube6.7'){ //引入Jenkinssonarqube环境
                sh &quot;&quot;&quot;
                cd ${currentProjectName}
                ${scannerHome}/bin/sonar-scanner
              &quot;&quot;&quot;
            }

        }


   }
   stage('编译，安装公共子工程') {
     sh &quot;mvn -f tensquare_common clean install&quot;
   }
   stage('编译，打包微服务工程，上传镜像') {
        for (int i=0; i&lt;selectedProjectNames.length; i++) {
            //tensquare_eureka_server@10086
            def projectInfo = selectedProjectNames[i];
            //当前遍历的项目名称
            def currentProjectName = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[0]
            //当前遍历的项目端口
            def currentProjectPort = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[1]
            sh &quot;echo '开始制作镜像'&quot;
            sh &quot;mvn -f ${currentProjectName}  clean package dockerfile:build&quot;
            sh &quot;echo '镜像制作好了'&quot;
            //定义镜像名称
            def imageName = &quot;${currentProjectName}:${tag}&quot;
            //对镜像打上标签
            sh &quot;docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}&quot;
            //把镜像推送到Harbor
            withCredentials([usernamePassword(credentialsId: &quot;${harbor_auth}&quot;, passwordVariable: 'password', usernameVariable: 'username')]) {
                    //登录到Harbor
                    sh &quot;docker login -u ${username} -p ${password} ${harbor_url}&quot;
                    //镜像上传
                    sh &quot;docker push ${harbor_url}/${harbor_project}/${imageName}&quot;
                    sh &quot;echo 镜像上传成功&quot;
            }
           //=====以下为远程调用进行项目部署========
           for(int j=0; j&lt;selectedServers.size(); j++){
               //每个服务名称
               def currentServer = selectedServers[j]
               //添加微服务运行时的参数：spring.profiles.active
               def activeProfile = &quot;--spring.profiles.active=&quot;
               if(currentServer==&quot;master_server&quot;){
                    activeProfile = activeProfile+&quot;eureka-server1&quot;
               }else if(currentServer==&quot;slave_server1&quot;){
                    activeProfile = activeProfile+&quot;eureka-server2&quot;
               }
                sh &quot;echo '应用部署开始'&quot;
                sshPublisher(publishers: [
                       sshPublisherDesc(configName: &quot;${currentServer}&quot;,
                       transfers: [
                           sshTransfer(cleanRemote: false,
                           excludes: '',
                           // 触发的命令，deploy.sh
                           execCommand: &quot;/opt/jenkins_shell/deployCluster.sh $harbor_url $harbor_project $currentProjectName $tag $currentProjectPort&quot;,
                           execTimeout: 120000,
                           flatten: false,
                           makeEmptyDirs: false,
                           noDefaultExcludes: false,
                           patternSeparator: '[ , ]+',
                           remoteDirectory: '',
                           remoteDirectorySDF: false,
                           removePrefix: '',
                           sourceFiles: '')
                       ],
                       usePromotionTimestamp: false,
                       useWorkspaceInPromotion: false,
                       verbose: false)
                ])
                sh &quot;echo '应用部署结束'&quot;
            }
        }
   }

}
</code></pre></div><p>3）在两个生产服务器中 &quot;/opt/jenkins_shell&quot; 目录下加入 &quot;deployCluster.sh&quot; 脚本，并授予执行权限；</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648361824-1628648361791-image-20210811001811353.png" alt=""></p> <p>deployCluster.sh</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#! /bin/sh</span>
<span class="token comment">#接收外部参数</span>
<span class="token assign-left variable">harbor_url</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">harbor_project_name</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">project_name</span><span class="token operator">=</span><span class="token variable">$3</span>
<span class="token assign-left variable">tag</span><span class="token operator">=</span><span class="token variable">$4</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$5</span>
<span class="token assign-left variable">profile</span><span class="token operator">=</span><span class="token variable">$6</span>

<span class="token assign-left variable">imageName</span><span class="token operator">=</span><span class="token variable">$harbor_url</span>/<span class="token variable">$harbor_project_name</span>/<span class="token variable">$project_name</span><span class="token builtin class-name">:</span><span class="token variable">$tag</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$imageName</span>&quot;</span>

<span class="token comment">#查询容器是否存在，存在则删除</span>
<span class="token assign-left variable">containerId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-w</span> $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>:$<span class="token punctuation">{</span>tag<span class="token punctuation">}</span>  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$containerId</span>&quot;</span> <span class="token operator">!=</span>  <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token comment">#停掉容器</span>
    <span class="token function">docker</span> stop <span class="token variable">$containerId</span>

    <span class="token comment">#删除容器</span>
    <span class="token function">docker</span> <span class="token function">rm</span> <span class="token variable">$containerId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;成功删除容器&quot;</span>
<span class="token keyword">fi</span>

<span class="token comment">#查询镜像是否存在，存在则删除</span>
<span class="token assign-left variable">imageId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> images <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-w</span> $project_name  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $3}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$imageId</span>&quot;</span> <span class="token operator">!=</span>  <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
      
    <span class="token comment">#删除镜像</span>
    <span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> <span class="token variable">$imageId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;成功删除镜像&quot;</span>
<span class="token keyword">fi</span>


<span class="token comment"># 登录Harbor</span>
<span class="token function">docker</span> login <span class="token parameter variable">-u</span> zhuangjie <span class="token parameter variable">-p</span> gkmzjaznH21 <span class="token variable">$harbor_url</span>

<span class="token comment"># 下载镜像</span>
<span class="token function">docker</span> pull <span class="token variable">$imageName</span>

<span class="token comment"># 启动容器</span>
<span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">-p</span> <span class="token variable">$port</span><span class="token builtin class-name">:</span><span class="token variable">$port</span> <span class="token variable">$imageName</span> <span class="token variable">$profile</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;容器启动成功&quot;</span>
</code></pre></div><p>注意：需要修改 Harbor 登录信息。</p> <h4 id="_2、高可用的nginx"><a href="#_2、高可用的nginx" class="header-anchor">#</a> 2、高可用的nginx</h4> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628686966488-1628686966378.png" alt=""></p> <p>1）安装Nginx（已完成）</p> <p>2）配置nginx</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>upstream zuulServer {
        server 192.168.87.103:10020 weight=1;
        server 192.168.87.104:10020 weight=1;
}
server {
        listen       9090;
        listen       [::]:80;
        server_name  _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
           proxy_pass http://zuulServer/;
    }
...

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2022年12月30日星期五下午4点40分</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.5c666aae.js" defer></script><script src="/assets/js/2.f4acce4e.js" defer></script><script src="/assets/js/10.7d647c34.js" defer></script>
  </body>
</html>
