<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins | 肥小猪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="肥小猪的笔记">
    <meta name="author" content="zhuangjie">
    <meta name="keywords" content="小庄的博客 小庄的笔记 zhuangjie 庄杰">
    
    <link rel="preload" href="/assets/css/0.styles.83bfd168.css" as="style"><link rel="preload" href="/assets/js/app.5c666aae.js" as="script"><link rel="preload" href="/assets/js/2.f4acce4e.js" as="script"><link rel="preload" href="/assets/js/9.757fe49c.js" as="script"><link rel="prefetch" href="/assets/js/10.7d647c34.js"><link rel="prefetch" href="/assets/js/11.ea5229fb.js"><link rel="prefetch" href="/assets/js/12.b859755e.js"><link rel="prefetch" href="/assets/js/13.94d3b5a2.js"><link rel="prefetch" href="/assets/js/14.ed2f4480.js"><link rel="prefetch" href="/assets/js/15.b3e305e6.js"><link rel="prefetch" href="/assets/js/16.49f8a835.js"><link rel="prefetch" href="/assets/js/17.f4b4e831.js"><link rel="prefetch" href="/assets/js/18.582de590.js"><link rel="prefetch" href="/assets/js/19.c85bd795.js"><link rel="prefetch" href="/assets/js/20.92741434.js"><link rel="prefetch" href="/assets/js/21.b7c8497e.js"><link rel="prefetch" href="/assets/js/22.96b46a67.js"><link rel="prefetch" href="/assets/js/23.0bc030ab.js"><link rel="prefetch" href="/assets/js/24.87f04d87.js"><link rel="prefetch" href="/assets/js/25.0f54baf2.js"><link rel="prefetch" href="/assets/js/26.1c39a9d2.js"><link rel="prefetch" href="/assets/js/27.31d22914.js"><link rel="prefetch" href="/assets/js/28.fc7f7405.js"><link rel="prefetch" href="/assets/js/29.1e94a8cc.js"><link rel="prefetch" href="/assets/js/3.c8d9910f.js"><link rel="prefetch" href="/assets/js/30.61082fbd.js"><link rel="prefetch" href="/assets/js/31.9e80c088.js"><link rel="prefetch" href="/assets/js/32.8ef6a48c.js"><link rel="prefetch" href="/assets/js/33.3349c1af.js"><link rel="prefetch" href="/assets/js/34.14ace618.js"><link rel="prefetch" href="/assets/js/35.3dca7364.js"><link rel="prefetch" href="/assets/js/36.25d01ad8.js"><link rel="prefetch" href="/assets/js/37.4527c97e.js"><link rel="prefetch" href="/assets/js/38.30b3c9ab.js"><link rel="prefetch" href="/assets/js/39.6f6d8c82.js"><link rel="prefetch" href="/assets/js/4.c72729ae.js"><link rel="prefetch" href="/assets/js/40.6454dbfd.js"><link rel="prefetch" href="/assets/js/41.ba49a8db.js"><link rel="prefetch" href="/assets/js/42.2ec3f8ee.js"><link rel="prefetch" href="/assets/js/43.e40c89c6.js"><link rel="prefetch" href="/assets/js/44.3d45a7aa.js"><link rel="prefetch" href="/assets/js/45.2375de76.js"><link rel="prefetch" href="/assets/js/46.a4cfa405.js"><link rel="prefetch" href="/assets/js/47.ab954289.js"><link rel="prefetch" href="/assets/js/48.4b72016d.js"><link rel="prefetch" href="/assets/js/49.9d06f5f2.js"><link rel="prefetch" href="/assets/js/5.44547aad.js"><link rel="prefetch" href="/assets/js/50.8dc92268.js"><link rel="prefetch" href="/assets/js/51.59e6212e.js"><link rel="prefetch" href="/assets/js/52.adecc9a3.js"><link rel="prefetch" href="/assets/js/53.030d635f.js"><link rel="prefetch" href="/assets/js/54.52060cbc.js"><link rel="prefetch" href="/assets/js/6.18c29f84.js"><link rel="prefetch" href="/assets/js/7.6427b380.js"><link rel="prefetch" href="/assets/js/8.67154bc3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.83bfd168.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="肥小猪" class="logo"> <span class="site-name can-hide">肥小猪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/程序员的自身修养.html" class="nav-link">
  总览
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/程序员的自身修养.html" class="nav-link">
  总览
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Jenkins</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/DevOps/Jenkins/Jenkins.html#目录" class="sidebar-link">目录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【环境的安装】" class="sidebar-link">【环境的安装】</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【gitlab安装】" class="sidebar-link">【GitLab安装】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【jenkins安装】" class="sidebar-link">【Jenkins安装】</a></li></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#从gitlab上拉取代码" class="sidebar-link">从gitlab上拉取代码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#加入maven进行自动构建打包" class="sidebar-link">加入Maven进行自动构建打包</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【web服务器】项目部署服务器的创建与配置" class="sidebar-link">【Web服务器】项目部署服务器的创建与配置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【构建】实现自由风格的项目构建" class="sidebar-link">【构建】实现自由风格的项目构建</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#改动后持续集成" class="sidebar-link">改动后持续集成</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【构建】使用maven进行项目构建" class="sidebar-link">【构建】使用Maven进行项目构建</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【构建】使用流水线进行项目构建" class="sidebar-link">【构建】使用流水线进行项目构建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#改为项目本地" class="sidebar-link">改为项目本地：</a></li></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【触发】项目构建触发器" class="sidebar-link">【触发】项目构建触发器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#_1、触发远程构建" class="sidebar-link">1、触发远程构建</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#_2、其它工程构建后触发" class="sidebar-link">2、其它工程构建后触发</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#_3、定时构建" class="sidebar-link">3、定时构建</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#_4、轮询-scm" class="sidebar-link">4、轮询 SCM</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#_5、代码仓库触发构建" class="sidebar-link">5、代码仓库触发构建</a></li></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【副加】参数化构建" class="sidebar-link">【副加】参数化构建</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【邮箱】邮箱功能" class="sidebar-link">【邮箱】邮箱功能</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【sonar代码审查】" class="sidebar-link">【Sonar代码审查】</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#sonar与jenkins整合" class="sidebar-link">Sonar与Jenkins整合</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#应用到项目构建中" class="sidebar-link">应用到项目构建中</a></li></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【分布式项目部署】" class="sidebar-link">【分布式项目部署】</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【docker安装】" class="sidebar-link">【Docker安装】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【docker命令】" class="sidebar-link">【docker命令】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【镜像的制作】" class="sidebar-link">【镜像的制作】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【harbor安装】" class="sidebar-link">【Harbor安装】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【项目与用户】" class="sidebar-link">【项目与用户】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【推送镜像到harbor】" class="sidebar-link">【推送镜像到Harbor】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【从harbor拉取镜像】" class="sidebar-link">【从Harbor拉取镜像】</a></li></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【微服务持续集成】" class="sidebar-link">【微服务持续集成】</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【将代码上传到gitlab】" class="sidebar-link">【将代码上传到GitLab】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【jenkins拉取与构建】" class="sidebar-link">【Jenkins拉取与构建】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【加入代码审查】" class="sidebar-link">【加入代码审查】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【编译打包】" class="sidebar-link">【编译打包】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【镜像制作】" class="sidebar-link">【镜像制作】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【应用部署】" class="sidebar-link">【应用部署】</a></li></ul></li><li><a href="/note/DevOps/Jenkins/Jenkins.html#【后端代码部署优化】" class="sidebar-link">【后端代码部署优化】</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【代码的修改】" class="sidebar-link">【代码的修改】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【jenkins中创建项目】" class="sidebar-link">【jenkins中创建项目】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【代码审查】" class="sidebar-link">【代码审查】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【上传镜像到harbor】" class="sidebar-link">【上传镜像到Harbor】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【应用部署】-2" class="sidebar-link">【应用部署】</a></li><li class="sidebar-sub-header"><a href="/note/DevOps/Jenkins/Jenkins.html#【高可用的nginx】" class="sidebar-link">【高可用的nginx】</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jenkins"><a href="#jenkins" class="header-anchor">#</a> Jenkins</h1> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <ul><li><p><a href="#%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85">【环境的安装】</a></p> <ul><li><p><a href="#gitlab%E5%AE%89%E8%A3%85">【GitLab安装】</a></p></li> <li><p><a href="#jenkins%E5%AE%89%E8%A3%85">【Jenkins安装】</a></p></li></ul></li> <li><p><a href="#%E4%BB%8Egitlab%E4%B8%8A%E6%8B%89%E5%8F%96%E4%BB%A3%E7%A0%81">从gitlab上拉取代码</a></p></li> <li><p><a href="#%E5%8A%A0%E5%85%A5maven%E8%BF%9B%E8%A1%8C%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E6%89%93%E5%8C%85">加入Maven进行自动构建打包</a></p></li> <li><p><a href="#web%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE">【Web服务器】项目部署服务器的创建与配置</a></p></li> <li><p><a href="#%E6%9E%84%E5%BB%BA%E5%AE%9E%E7%8E%B0%E8%87%AA%E7%94%B1%E9%A3%8E%E6%A0%BC%E7%9A%84%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA">【构建】实现自由风格的项目构建</a></p></li> <li><p><a href="#%E6%94%B9%E5%8A%A8%E5%90%8E%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90">改动后持续集成</a></p></li> <li><p><a href="#%E6%9E%84%E5%BB%BA%E4%BD%BF%E7%94%A8maven%E8%BF%9B%E8%A1%8C%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA">【构建】使用Maven进行项目构建</a></p></li> <li><p><a href="#%E6%9E%84%E5%BB%BA%E4%BD%BF%E7%94%A8%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%BF%9B%E8%A1%8C%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA">【构建】使用流水线进行项目构建</a></p> <ul><li><a href="#%E6%94%B9%E4%B8%BA%E9%A1%B9%E7%9B%AE%E6%9C%AC%E5%9C%B0">改为项目本地：</a></li></ul></li> <li><p><a href="#%E8%A7%A6%E5%8F%91%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8">【触发】项目构建触发器</a></p> <ul><li><p><a href="#1%E8%A7%A6%E5%8F%91%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA">1、触发远程构建</a></p></li> <li><p><a href="#2%E5%85%B6%E5%AE%83%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA%E5%90%8E%E8%A7%A6%E5%8F%91">2、其它工程构建后触发</a></p></li> <li><p><a href="#3%E5%AE%9A%E6%97%B6%E6%9E%84%E5%BB%BA">3、定时构建</a></p></li> <li><p><a href="#4%E8%BD%AE%E8%AF%A2-scm">4、轮询 SCM</a></p></li> <li><p><a href="#5%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93%E8%A7%A6%E5%8F%91%E6%9E%84%E5%BB%BA">5、代码仓库触发构建</a></p></li></ul></li> <li><p><a href="#%E5%89%AF%E5%8A%A0%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA">【副加】参数化构建</a></p></li> <li><p><a href="#%E9%82%AE%E7%AE%B1%E9%82%AE%E7%AE%B1%E5%8A%9F%E8%83%BD">【邮箱】邮箱功能</a></p></li> <li><p><a href="#sonar%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5">【Sonar代码审查】</a></p> <ul><li><p><a href="#%E5%AE%89%E8%A3%85">安装</a></p></li> <li><p><a href="#sonar%E4%B8%8Ejenkins%E6%95%B4%E5%90%88">Sonar与Jenkins整合</a></p></li> <li><p><a href="#%E5%BA%94%E7%94%A8%E5%88%B0%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E4%B8%AD">应用到项目构建中</a></p></li></ul></li> <li><p><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2">【分布式项目部署】</a></p> <ul><li><p><a href="#docker%E5%AE%89%E8%A3%85">【Docker安装】</a></p></li> <li><p><a href="#docker%E5%91%BD%E4%BB%A4">【docker命令】</a></p></li> <li><p><a href="#%E9%95%9C%E5%83%8F%E7%9A%84%E5%88%B6%E4%BD%9C">【镜像的制作】</a></p></li> <li><p><a href="#harbor%E5%AE%89%E8%A3%85">【Harbor安装】</a></p></li> <li><p><a href="#%E9%A1%B9%E7%9B%AE%E4%B8%8E%E7%94%A8%E6%88%B7">【项目与用户】</a></p></li> <li><p><a href="#%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0harbor">【推送镜像到Harbor】</a></p></li> <li><p><a href="#%E4%BB%8Eharbor%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F">【从Harbor拉取镜像】</a></p></li></ul></li> <li><p><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90">【微服务持续集成】</a></p> <ul><li><p><a href="#%E5%B0%86%E4%BB%A3%E7%A0%81%E4%B8%8A%E4%BC%A0%E5%88%B0gitlab">【将代码上传到GitLab】</a></p></li> <li><p><a href="#jenkins%E6%8B%89%E5%8F%96%E4%B8%8E%E6%9E%84%E5%BB%BA">【Jenkins拉取与构建】</a></p></li> <li><p><a href="#%E5%8A%A0%E5%85%A5%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5">【加入代码审查】</a></p></li> <li><p><a href="#%E7%BC%96%E8%AF%91%E6%89%93%E5%8C%85">【编译打包】</a></p></li> <li><p><a href="#%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C">【镜像制作】</a></p></li> <li><p><a href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2">【应用部署】</a></p></li></ul></li> <li><p><a href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E9%83%A8%E7%BD%B2%E4%BC%98%E5%8C%96">【后端代码部署优化】</a></p> <ul><li><p><a href="#%E4%BB%A3%E7%A0%81%E7%9A%84%E4%BF%AE%E6%94%B9">【代码的修改】</a></p></li> <li><p><a href="#jenkins%E4%B8%AD%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE">【jenkins中创建项目】</a></p></li> <li><p><a href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5">【代码审查】</a></p></li> <li><p><a href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E5%88%B0harbor">【上传镜像到Harbor】</a></p></li> <li><p><a href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2-1">【应用部署】</a></p></li> <li><p><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84nginx">【高可用的nginx】</a></p></li></ul></li></ul> <h2 id="【环境的安装】"><a href="#【环境的安装】" class="header-anchor">#</a> 【环境的安装】</h2> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626248340612-1626248340557.png" alt=""></p> <p>以下步骤：创建Gitlab服务器与配置-&gt; 创建Jenkins服务与配置</p> <p>上面两个步骤请参考：<a href="https://blog.csdn.net/hancoder/article/details/118233786" title="https://blog.csdn.net/hancoder/article/details/118233786" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/hancoder/article/details/118233786<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="【gitlab安装】"><a href="#【gitlab安装】" class="header-anchor">#</a> 【GitLab安装】</h3> <p>Gitlab安装</p> <ol><li>安装相关依赖</li></ol> <p>yum -y install policycoreutils openssh-server openssh-clients postﬁx</p> <ol><li>启动ssh服务&amp;设置为开机启动</li></ol> <p>systemctl enable sshd &amp;&amp; sudo systemctl start sshd</p> <ol><li>设置postﬁx开机自启，并启动，postﬁx支持gitlab发信功能</li></ol> <p>systemctl enable postﬁx &amp;&amp; systemctl start postﬁx</p> <ol><li>开放ssh以及http服务，然后重新加载防火墙列表 ﬁrewall-cmd --add-service=ssh --permanent ﬁrewall-cmd --add-service=http --permanent ﬁrewall-cmd --reload</li></ol> <p>如果关闭防火墙就不需要做以上配置</p> <ol><li>下载gitlab包，并且安装在线下载安装包：</li></ol> <p>wget <a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x" title="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x" target="_blank" rel="noopener noreferrer">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 86_64.rpm</p> <p>安装：</p> <p>rpm -i gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm</p> <ol><li>修改gitlab配置</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> /etc/gitlab/gitlab.rb
<span class="token comment">#修改gitlab访问地址和端口，默认为80，我们改为82 external_url ‘http://192.168.66.100:82’</span>
<span class="token comment">#nginx[‘listen_port’] = 82</span>
</code></pre></div><ol><li>重载配置及启动gitlab</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>gitlab-ctl reconﬁgure
gitlab-ctl restart
</code></pre></div><ol><li>把端口添加到防火墙</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>ﬁrewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">82</span>/tcp <span class="token parameter variable">--permanent</span> 
ﬁrewall-cmd <span class="token parameter variable">--reload</span>
</code></pre></div><p>启动成功后，看到以下修改管理员root密码的页面，修改密码后，然后登录即可</p> <h3 id="【jenkins安装】"><a href="#【jenkins安装】" class="header-anchor">#</a> 【Jenkins安装】</h3> <p>这里介绍两种方法，一种方法将最新版jenkins加入到yum源，另外一种是下载指定版本的rpm包</p> <p>1）安装JDK</p> <p>2）安装jenkins</p> <p>wget -O ：下载并以不同的文件名保存</p> <p>yum的repo中默认没有Jenkins，需要先将Jenkins存储库添加到yum repos，执行下面的命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
<span class="token function">rpm</span> <span class="token parameter variable">--import</span> https://pkg.jenkins.io/redhat-stable/jenkins.io.key
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> jenkins <span class="token comment">#默认安装最新的</span>
systemctl <span class="token builtin class-name">enable</span> jenkins  <span class="token comment">#开机自启</span>
<span class="token function">vim</span> /etc/sysconfig/jenkins   <span class="token comment">#修改内容： JENKINS_USER=“root” JENKINS_PORT=“8888”</span>
<span class="token function">service</span> jenkins start  <span class="token comment">#启动</span>
</code></pre></div><p>打开浏览器访问 <a href="http://xn--ip-5f7ew23b:8888" title="http://电脑ip:8888" target="_blank" rel="noopener noreferrer">http://电脑ip:8888<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>创建一个管理员用户 -&gt;  实例配置  -&gt; 可以安装推荐的插件或另一种。</p> <p>3）配置为国内插件下载地址：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>cd /var/lib/jenkins/updates
sed -i 's/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g' default.json
sed -i 's/http:\/\/www.google.com/https:\/\/www.baidu.com/g' default.json
</code></pre></div><p>Manage Plugins点击Advanced，把Update Site改为国内插件下载地址：</p> <p><a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json" title="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json" target="_blank" rel="noopener noreferrer">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Sumbit后，在浏览器输入： <a href="http://xn--101ip-fz1iv81h:8888/restart" title="http://101机器ip:8888/restart" target="_blank" rel="noopener noreferrer">http://101机器ip:8888/restart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，重启Jenkins</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627721279406-1627721279398.png" alt=""></p> <p>4）安装中文插件</p> <p>安装插件的插件后，会帮我们安装中文插件，如果没有搜索&quot;Chinese&quot;，安装</p> <h2 id="从gitlab上拉取代码"><a href="#从gitlab上拉取代码" class="header-anchor">#</a> 从gitlab上拉取代码</h2> <p>以下步骤：使用普通凭证从gitlab上拉取代码 -&gt;  使用ssh凭证从gitlab上拉取代码</p> <p><code>实现在Jenkins上拉取Gitlab上的代码</code></p> <p>在Kenkins上安装Credentials Binding ,安装 Git插件 、在Kenkins服务器上安装git (yum install git -y  &amp;&amp; git --version)</p> <p>1、创建普通凭证</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626250522291-1626250522234.png" alt=""></p> <p>2、创建一个项目，从gitlab上拉取代码</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251037486-1626251037450-image-20210714162315906.png" alt=""></p> <p>3、拉取</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251148690-1626251148679.png" alt=""></p> <p><code>使用ssh凭证来拉取</code></p> <p>1、使用ssh-keygen生成ssh，打开/root/.ssh/下cat公钥  复制到gitlab设置中的ssh：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251665628-1626251665529.png" alt=""></p> <p>2、配置ssh凭证</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626252147796-1626252147756-image-20210714164202919.png" alt=""></p> <p>3、在Jenkins项目中</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626252294465-1626252294427.png" alt=""></p> <p>4、拉取</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251148690-1626251148679.png" alt=""></p> <h2 id="加入maven进行自动构建打包"><a href="#加入maven进行自动构建打包" class="header-anchor">#</a> 加入Maven进行自动构建打包</h2> <p>就是可以在Jenkins对拉取的代码进行打包</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626258766265-1626258766237.png" alt=""></p> <p>以下步骤：服务器上配置需要的环境   --&gt;  Jenkins上配置 --&gt;  对项目进行打包</p> <p>1、在jenkins的服务器上安装java 、 maven配置环境；</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/local/jdk/jdk1.8.0_291
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JAVA_HOME</span>/jre/bin:<span class="token environment constant">$PATH</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/lib:<span class="token variable">$JAVA_HOME</span>/jre/lib

<span class="token comment">#maven</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MAVEN_HOME</span><span class="token operator">=</span>/usr/local/maven
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$MAVEN_HOME</span>/bin
</code></pre></div><p>2、Jenkins上配置</p> <p>配置1：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259189981-1626259189950.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259391664-1626259391644.png" alt=""></p> <p>配置2：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627725746059-1627725746011.png" alt=""></p> <p>3、对项目进行打包</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259620762-1626259620743.png" alt=""></p> <h2 id="【web服务器】项目部署服务器的创建与配置"><a href="#【web服务器】项目部署服务器的创建与配置" class="header-anchor">#</a> 【Web服务器】项目部署服务器的创建与配置</h2> <p>就是创建项目运行所需的环境，即安装有tomcat服务器，然后配置tomcat</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626248340612-1626248340557.png" alt=""></p> <p>1、创建服务器在服务器上安装与配置tomcat</p> <p>下载 ：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317633809-1626317633802.png" alt=""></p> <p>启动tomcat:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/usr/local/tomcat/apache-tomcat-8.5.69/bin
<span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># ./startup.sh</span>
</code></pre></div><p>开放tomcat的8080端口：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">8080</span>/tcp <span class="token parameter variable">--permanent</span>  <span class="token comment">#开放8080端口</span>
firewall-cmd <span class="token parameter variable">--reload</span>  <span class="token comment">#重启防火墙</span>
</code></pre></div><p>访问服务器的8080端口，进入指定页面：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626316981745-1626316981736.png" alt=""></p> <p>配置1（配置了登录信息）:</p> <p>vim  /usr/local/tomcat/apache-tomcat-8.5.69/conf/tomcat-users.xml</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tomcat-users</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tomcat<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>role1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manager-script<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manager-gui<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manager-status<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>admin-gui<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>admin-script<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tomcat<span class="token punctuation">&quot;</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tomcat<span class="token punctuation">&quot;</span></span> <span class="token attr-name">roles</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>manager-gui,manager-script,tomcat,admin-gui,admin-script<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tomcat-users</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317427813-1626317427807.png" alt=""></p> <p>配置2：</p> <p>vim   /usr/local/tomcat/apache-tomcat-8.5.69/webapps/manager/META-INF/context.xml</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317357259-1626317357234.png" alt=""></p> <p>重启</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./shutdown.sh <span class="token comment">#停止</span>
./startup.sh <span class="token comment">#启动</span>
</code></pre></div><p>再次访问或刷新刚才的403页面（上面配置了登录信息是：tomcat  tomcat）：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317528836-1626317528820.png" alt=""></p> <p>显示：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317555591-1626317555588.png" alt=""></p> <h2 id="【构建】实现自由风格的项目构建"><a href="#【构建】实现自由风格的项目构建" class="header-anchor">#</a> 【构建】实现自由风格的项目构建</h2> <p>就是jenkins服务器向gitlab服务器获取代码后进行构建，然后将构建好生成的war包部署到tomcat服务器上。我们要做的是设置构建过程。</p> <p>以下步骤：gitlab服务器项目的准备 -&gt;  jenkins构建环境的准备  -&gt; 开始构建部署</p> <p><strong>1、gitlab服务器项目的准备</strong></p> <p>项目准备：<a href="https://github.com/18476305640/web_dome" title="https://github.com/18476305640/web_dome" target="_blank" rel="noopener noreferrer">https://github.com/18476305640/web_dome<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在gitlab上创建一个项目，提交上传，得到：<a href="mailto:git@192.168.208.136" title="git@192.168.208.136">git@192.168.208.136</a>:zhuangjie/web_demo_freestyle.git</p> <p><strong>2、jenkins构建环境的准备</strong></p> <p>​	1）安装插件</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626409798823-1626409798816.png" alt=""></p> <p>​	2）源码管理</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626410689844-1626410689829.png" alt=""></p> <p>​	3）构建</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626409915126-1626409915107.png" alt=""></p> <p>​	4）构建后操作（新内容）</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626410192277-1626410192254-image-20210716123603979.png" alt=""></p> <p>​	<strong>3、开始构建</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626410540606-1626410540586.png" alt=""></p> <h2 id="改动后持续集成"><a href="#改动后持续集成" class="header-anchor">#</a> 改动后持续集成</h2> <p>我们能实现三个服务器的联动工作后，我们日常只需要使用git push 将代码上传到gitlab上，然后在jenkins中进行构建即可。</p> <h2 id="【构建】使用maven进行项目构建"><a href="#【构建】使用maven进行项目构建" class="header-anchor">#</a> 【构建】使用Maven进行项目构建</h2> <p>上面我们使用的是自由风格进行了项目构建，现在我们要进行maven风格来进行项目构建，与之不同的地方并不多。下面就来演示一下：</p> <p>以下步骤：安装插件  -&gt;  构建项目  -&gt; 查看</p> <p><code>1、安装插件</code></p> <p>Maven Integration插件，不用重启也可用。</p> <p><code>2、构建项目</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626417502304-1626417502240.png" alt=""></p> <p>部署：</p> <p>修改代码，push后，点击构建项目</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626417981588-1626417981549.png" alt=""></p> <p><code>3、查看</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626418094970-1626418094944.png" alt=""></p> <h2 id="【构建】使用流水线进行项目构建"><a href="#【构建】使用流水线进行项目构建" class="header-anchor">#</a> 【构建】使用流水线进行项目构建</h2> <p>流水线构建项目，构建项目由之前的流程式转为了脚本（Pipeline）,我们创建一个流水线项目后，我们只需编写/生成一个Pipeline 即可完成对项目的拉取、构建、部署等操作。</p> <p>以下步骤：安装插件（Pipeline，安装推荐的插件中包含）  -&gt; 进行项目构建脚本（Pipeline）书写  -&gt;  查看</p> <p><code>1、安装插件</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626419582840-1626419582796.png" alt=""></p> <p>2、创建一个流水线的项目</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626425094651-1626425094634.png" alt=""></p> <p>3、编写/生成 Pipeline脚本实现项目的拉取、构建、部署</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626425126026-1626425126010.png" alt=""></p> <p>来自：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626424995322-1626424995301.png" alt=""></p> <h3 id="改为项目本地"><a href="#改为项目本地" class="header-anchor">#</a> 改为项目本地：</h3> <p>1、在流水线项目上修改：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626426369402-1626426369370.png" alt=""></p> <p>2、项目中，添加一个文件：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626426478007-1626426477966.png" alt=""></p> <h2 id="【触发】项目构建触发器"><a href="#【触发】项目构建触发器" class="header-anchor">#</a> 【触发】项目构建触发器</h2> <h3 id="_1、触发远程构建"><a href="#_1、触发远程构建" class="header-anchor">#</a> 1、触发远程构建</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626459590220-1626459590214.png" alt=""></p> <h3 id="_2、其它工程构建后触发"><a href="#_2、其它工程构建后触发" class="header-anchor">#</a> 2、其它工程构建后触发</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626459881414-1626459881392.png" alt=""></p> <h3 id="_3、定时构建"><a href="#_3、定时构建" class="header-anchor">#</a> 3、定时构建</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626489980663-1626489980633.png" alt=""></p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>每30分钟构建一次：H代表形参 H/30 * * * * 10:02 10:32

每2个小时构建一次: H H/2 * * *

每天的8点，12点，22点，一天构建3次： (多个时间点中间用逗号隔开) 0 8,12,22 * * *

每天中午12点定时构建一次 H 12 * * *

每天下午18点定时构建一次 H 18 * * *

在每个小时的前半个小时内的每10分钟 H(0-29)/10 * * * *

每两小时一次，每个工作日上午9点到下午5点(也许是上午10:38，下午12:38，下午2:38，下午4:38) H H(9-16)/2 * * 1-5
</code></pre></div><h3 id="_4、轮询-scm"><a href="#_4、轮询-scm" class="header-anchor">#</a> 4、轮询 SCM</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626490561413-1626490561372.png" alt=""></p> <h3 id="_5、代码仓库触发构建"><a href="#_5、代码仓库触发构建" class="header-anchor">#</a> 5、代码仓库触发构建</h3> <p>前面的几种构建触发器都不够好，就算是轮询SCM也会消耗我们的系统资源，拖慢jenkins的运行速度。下面我们就演示如果让gitlab来触发jenkins的项目构建。</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493715277-1626493715263.png" alt=""></p> <p>需要安装GitlabHook插件：需要安装两个插件： Gitlab Hook和GitLab</p> <p>​	1）项目触发器（复制下面图片首行的那个链接，备用）</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626492610080-1626492610030.png" alt=""></p> <p>​	2）在Jenkins中，Manage Jenkins-&gt;Conﬁgure System</p> <p>不取消勾选，jenkins将不能正常接收gitlab发送的触发信息。</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626492754499-1626492754469-382093cee2597d9990ee111babc36b21.jpg" alt=""></p> <p>3）gitlab：使用root管理员帐号登录，开启对应服务</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493399071-1626493399029.png" alt=""></p> <p>4）使用项目账号登录，进入项目</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493574213-1626493574200.png" alt=""></p> <p>进行如下 测试，回到jenkins发现触发了项目构建！</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493633032-1626493633021.png" alt=""></p> <h2 id="【副加】参数化构建"><a href="#【副加】参数化构建" class="header-anchor">#</a> 【副加】参数化构建</h2> <p>1、jenkins项目中设置参数</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626510691515-1626510691500.png" alt=""></p> <p>2、在pipelish脚本中使用该参数</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626510755563-1626510755554.png" alt=""></p> <p>3、执行参数化构建项目 （已测试）</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626510632687-1626510632683.png" alt=""></p> <h2 id="【邮箱】邮箱功能"><a href="#【邮箱】邮箱功能" class="header-anchor">#</a> 【邮箱】邮箱功能</h2> <p>以下步骤：邮箱服务开启  -&gt;   jenkins配置</p> <p><code>邮箱服务开启</code></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626516270004-1626516269977.png" alt=""></p> <p>比如得到的授权码：CAPOTZETCGUFSOVC</p> <p><code>jenkins配置</code></p> <p>安装插件：Email Extension插件 template</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626515704616-1626515704587.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626516328030-1626516328027.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626516132502-1626516132500.png" alt=""></p> <blockquote><p>配置好上面后，现在我们开始应用到项目中。
现在流程是这样的，现在我们在jenkins项目中，该项目是一个流水线+参数化的构建项目，在jenkins中需要设置拉取构建流程的&quot;jenkinsfile&quot; 的pipelish脚本文件。它可以不是项目本身：</p></blockquote> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626699189512-1626699189503.png" alt=""></p> <blockquote><p>具体的项目构建由该脚本决定的~</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>pipeline <span class="token punctuation">{</span>
   agent any

   stages <span class="token punctuation">{</span>
      <span class="token function">stage</span><span class="token punctuation">(</span>'pull code'<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token char">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> '<span class="token operator">*</span><span class="token operator">/</span>$<span class="token punctuation">{</span>branch<span class="token punctuation">}</span>'<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> 'b632ed00<span class="token operator">-</span>fc81<span class="token operator">-</span><span class="token number">43</span>c8<span class="token operator">-</span>a746<span class="token operator">-</span><span class="token number">5</span>aa0673b2658'<span class="token punctuation">,</span> url<span class="token operator">:</span> 'git<span class="token annotation punctuation">@192.168.208.149</span><span class="token operator">:</span>zhuangjie<span class="token operator">/</span>web_demo_freestyle<span class="token punctuation">.</span>git'<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">stage</span><span class="token punctuation">(</span>'build project'<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            sh 'mvn clean <span class="token keyword">package</span>'
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">stage</span><span class="token punctuation">(</span>'publish project'<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            deploy adapters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tomcat8</span><span class="token punctuation">(</span>credentialsId<span class="token operator">:</span> '<span class="token number">54d</span>ea36f<span class="token operator">-</span>c9ed<span class="token operator">-</span><span class="token number">4925</span><span class="token operator">-</span><span class="token number">9d</span><span class="token number">25</span><span class="token operator">-</span>ea4ba77d7b78'<span class="token punctuation">,</span> path<span class="token operator">:</span> ''<span class="token punctuation">,</span> url<span class="token operator">:</span> 'http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.208</span><span class="token number">.151</span><span class="token operator">:</span><span class="token number">8080</span>'<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> contextPath<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> war<span class="token operator">:</span> 'target<span class="token comment">/*.war'
         }
      }

   }
   post {
         always {
             emailext(
                 subject: '构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} -${BUILD_STATUS}!',
                 body: '${FILE,path=&quot;email.html&quot;}',
                 to: '2119299531@qq.com'
             )
         }
   }
}
</span></code></pre></div><p>分析：pipeline  {stages...   post... }  其中stages是构建流程，<code>post</code>是构建成功后的操作。我们在此下的always（不管成功或失败，当然也可以是成功或失败）中发送邮件。</p> <p>该脚本使用了以下作为邮件模板，位于项目的根目录下：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626699623460-1626699623452.png" alt=""></p> <p>email.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>${ENV, var=&quot;JOB_NAME&quot;}-第${BUILD_NUMBER}次构建日志<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">leftmargin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>8<span class="token punctuation">&quot;</span></span> <span class="token attr-name">marginwidth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">topmargin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>8<span class="token punctuation">&quot;</span></span> <span class="token attr-name">marginheight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>4<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>95%<span class="token punctuation">&quot;</span></span> <span class="token attr-name">cellpadding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">cellspacing</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span>
       <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> 11pt<span class="token punctuation">;</span> <span class="token property">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> sans-serif</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>(本邮件是程序自动下发的，请勿回复！)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#0000FF<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>构建结果 - ${BUILD_STATUS}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#0B610B<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>构建信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100%<span class="token punctuation">&quot;</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>项目名称<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>${PROJECT_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>构建编号<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>第${BUILD_NUMBER}次构建<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>触发原因：<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>${CAUSE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>构建日志：<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${BUILD_URL}console<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>${BUILD_URL}console<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>构建<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>Url<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${BUILD_URL}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>${BUILD_URL}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>工作目录<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${PROJECT_URL}ws<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>${PROJECT_URL}ws<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>项目<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>Url<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${PROJECT_URL}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>${PROJECT_URL}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#0B610B<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Changes Since Last
      Successful Build:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100%<span class="token punctuation">&quot;</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>历史变更记录 : <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${PROJECT_URL}changes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>${PROJECT_URL}changes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span> ${CHANGES_SINCE_LAST_SUCCESS,reverse=true, format=&quot;Changes for Build #%n:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>%c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>&quot;,showPaths=true,changesFormat=&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>[%a]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>%m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>&quot;,pathFormat=&quot;<span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&amp;nbsp;">&amp;nbsp;</span>%p&quot;}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>Failed Test Results<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100%<span class="token punctuation">&quot;</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span>
            <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> 11pt<span class="token punctuation">;</span> <span class="token property">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> sans-serif</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>$FAILED_TESTS<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#0B610B<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>构建日志 (最后 100行):<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100%<span class="token punctuation">&quot;</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>center<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>80<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>30<span class="token punctuation">&quot;</span></span> <span class="token attr-name">readonly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>readonly<span class="token punctuation">&quot;</span></span>
                  <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">font-family</span><span class="token punctuation">:</span> Courier New</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>${BUILD_LOG, maxLines=100}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>除此，还需要设置邮箱这html格式进行发送：（在这下面搜索html,好像没有，但教程是这样的）</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626704078478-1626704078470-image-20210719221412626.png" alt=""></p> <h2 id="【sonar代码审查】"><a href="#【sonar代码审查】" class="header-anchor">#</a> 【Sonar代码审查】</h2> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <blockquote><p><strong>注意，sonar6.7版本需要一个mysql5.7的数据库，jdk1.8以上比如8.5</strong> ，然后再创建一个名为<code>sonar</code> 的数据库。然后再开始安装Sonar，启动后再开放端口且登录获取token ：</p></blockquote> <p>以下步骤：保证存在名为sonar的数据库 -&gt;  安装Conar  -&gt; 余下工作</p> <p><code>保证存在名为sonar的数据库</code></p> <p><code>安装Conar</code></p> <p>下载sonar压缩包： <a href="https://www.sonarqube.org/downloads/" title="https://www.sonarqube.org/downloads/" target="_blank" rel="noopener noreferrer">https://www.sonarqube.org/downloads/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token function">unzip</span>
<span class="token function">unzip</span> sonarqube-6.7.4.zip <span class="token comment">#解压</span>
<span class="token function">mkdir</span> /opt/sonar <span class="token comment">#创建目录</span>
<span class="token function">mv</span> sonarqube-6.7.4/* /opt/sonar <span class="token comment">#移动文件</span>

<span class="token function">useradd</span> sonar <span class="token comment">#创建sonar用户，必须sonar用于启动，否则报错</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> sonar. /opt/sonar <span class="token comment">#更改sonar目录及文件权限修改sonar配置文件</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> sonar. /usr/local/jdk/  <span class="token comment">#不确定是否需要这个授权！！！</span>
<span class="token function">vi</span>  /opt/sonarqube-6.7.4/conf/sonar.properties
<span class="token comment">#编辑内容：四个地方设置username  passowrd  url  端口（不理默认9000）</span>

<span class="token assign-left variable">sonar.jdbc.username</span><span class="token operator">=</span>root
<span class="token assign-left variable">sonar.jdbc.password</span><span class="token operator">=</span>Root@123  
<span class="token assign-left variable">sonar.jdbc.url</span><span class="token operator">=</span>jdbc:mysql://localhost:3306/sonar?useUnicode<span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">characterEncoding</span><span class="token operator">=</span>utf8<span class="token operator">&amp;</span><span class="token assign-left variable">rewriteBatchedStatements</span><span class="token operator">=</span>true<span class="token operator">&amp;</span>useConﬁgs<span class="token operator">=</span> maxPerformance<span class="token operator">&amp;</span><span class="token assign-left variable">useSSL</span><span class="token operator">=</span>false

<span class="token builtin class-name">cd</span> /opt/sonarqube-6.7.4

<span class="token comment">#su sonar 不能使用root用户启动！！！所以下面在root用户下使用如下使用启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh start <span class="token comment">#启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh status <span class="token comment">#查看状态</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh stop <span class="token comment">#停止</span>

<span class="token function">tail</span> <span class="token parameter variable">-f</span> logs/sonar.logs <span class="token comment">#查看日志访问sonar http://192.168.66.101:9000</span>
</code></pre></div><p><code>余下工作</code></p> <p>1)开放端口：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">9000</span>/tcp <span class="token parameter variable">--permanent</span> <span class="token comment">#永久开放该端口</span>
firewall-cmd <span class="token parameter variable">--reload</span>  <span class="token comment">#重启防火墙</span>
</code></pre></div><p>2)登录：默认  admin/admin</p> <p>​	获取token:</p> <p>​	输入admin , 得到如下信息,需要摘取保存token</p> <p>​	admin: <strong>30ab099e4edef87ef92ca6217da084c0260de47c</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626709303395-1626709303372.png" alt=""></p> <h3 id="sonar与jenkins整合"><a href="#sonar与jenkins整合" class="header-anchor">#</a> Sonar与Jenkins整合</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925229389-1626925229368.png" alt=""></p> <p>1、在Jenkins安装Sonar-Scanner工具</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925200244-1626925200242-image-20210720211841704.png" alt=""></p> <p>2、整合</p> <p>​	1)在Jenkins中安装SonarQube Scanner插件，用于连接ConarQube</p> <p>​	2)、Manage Jenkins-&gt;Global Tool Conﬁguration  添加一个凭证</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925096630-1626925096623-image-20210720211228770.png" alt=""></p> <p>​	3)在jenkins“系统配置”中，作如下配置</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925064354-1626925064346-image-20210720211416805.png" alt=""></p> <h3 id="应用到项目构建中"><a href="#应用到项目构建中" class="header-anchor">#</a> 应用到项目构建中</h3> <p><strong>JAVA_HOME等环境变量需要设置好！</strong> 我们应用在流水线的项目构建中，而其它的构建方式会相对简单。</p> <p>以下步骤： 在项目中加入sonar-project.properties审查文件  -&gt;  在pipelish脚本加入代码审查步骤</p> <p><code>1、在项目中加入sonar-project.properties审查文件</code></p> <p>在根目录下加入：</p> <p>sonar-project.properties</p> <div class="language-.properties extra-class"><pre class="language-text"><code># must be unique in a given SonarQube instance
sonar.projectKey=web_demo_pipline
# this is the name and version displayed in the SonarQube UI. Was mandatory prior to SonarQube 6.1.
sonar.projectName=web_demo_pipline
sonar.projectVersion=1.0

# Path is relative to the sonar-project.properties file. Replace &quot;\&quot; by &quot;/&quot; on Windows.
# This property is optional if sonar.modules is set.
sonar.sources=.
sonar.exclusions=**/test/**,**/target/**

sonar.java.source=1.8
sonar.java.target=1.8

# Encoding of the source code. Default is default system encoding
sonar.sourceEncoding=UTF-8
</code></pre></div><p><code>2、在pipelish脚本加入代码审查步骤</code></p> <p>在代码构建打包好后（生成target后），进行代码的审查</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>pipeline {
   agent any

   stages {
      stage('pull code') {
         steps {
            checkout([$class: 'GitSCM', branches: [[name: '*/${branch}']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'b632ed00-fc81-43c8-a746-5aa0673b2658', url: 'git@192.168.208.149:zhuangjie/web_demo_freestyle.git']]])
         }
      }
      stage('code checking') {
          steps {
              script {
                   //引入SonarQubeScanner工具
                  scannerHome = tool 'SonarQube-Scanner'   //第二步整合中安装Sonar-Scanner工具起的名字
              }
              //引入SonarQube的服务器环境
              withSonarQubeEnv('ConarQube6.7') {  //第二步整合中配置进Jenkins中起的服务的名字
                  sh &quot;${scannerHome}/bin/sonar-scanner&quot;
              }
          }
      }
      stage('build project') {
         steps {
            sh 'mvn clean package'
         }
      }
      stage('publish project') {
         steps {
            deploy adapters: [tomcat8(credentialsId: '54dea36f-c9ed-4925-9d25-ea4ba77d7b78', path: '', url: 'http://192.168.208.153:8080')], contextPath: null, war: 'target/*.war'
         }
      }

   }
   post {
         always {
             emailext(
                 subject: '构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} -${BUILD_STATUS}!',
                 body: '${FILE,path=&quot;email.html&quot;}',
                 to: '2119299531@qq.com'
             )
         }
   }
}
</code></pre></div><p>然后进行代码的构建！首次会进行下载安装SonarQube Scanner</p> <p>加入异常代码后进行构建，SonarQube中：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925023961-1626925023954-image-20210720223752856.png" alt=""></p> <h2 id="【分布式项目部署】"><a href="#【分布式项目部署】" class="header-anchor">#</a> 【分布式项目部署】</h2> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627046616524-1627046616423.png" alt=""></p> <p>大致流程说明：
1）开发人员每天把代码提交到Gitlab代码仓库
2）Jenkins从Gitlab中拉取项目源码，编译并打成jar包，然后构建成Docker镜像，将镜像上传到
Harbor私有仓库。
3）Jenkins发送SSH远程命令，让生产部署服务器到Harbor私有仓库拉取镜像到本地，然后创建容器。
4）最后，用户可以访问到容器</p> <p>【Docker环境】</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627046771291-1627046771238.png" alt=""></p> <p>Docker 是一个开源的应用容器引擎，基于 Go 语言 并遵从 Apache2.0 协议开源。
Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流
行的 Linux 机器上，也可以实现虚拟化。
容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销
极低。</p> <p>Docker容器技术 vs 传统虚拟机技术</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627046966863-1627046966759.png" alt=""></p> <table><thead><tr><th></th> <th>虚拟机</th> <th>容器</th></tr></thead> <tbody><tr><td>占用磁盘空间</td> <td>非常大,GB级</td> <td>小，MB甚至KB级</td></tr> <tr><td>启动速度</td> <td>慢，分钟级</td> <td>快，秒级</td></tr> <tr><td>对运行形态</td> <td>运行在Hypervisor上</td> <td>直接运行在宿主机内核上</td></tr> <tr><td>并发性</td> <td>一台宿主机上十几个，最多几十个</td> <td>上百个，甚至数百上千个</td></tr> <tr><td>性能</td> <td>逊于宿主机</td> <td>接近宿主机本地进程</td></tr> <tr><td>资源利用率</td> <td>低</td> <td>高</td></tr></tbody></table> <p>简单一句话总结：Docker<strong>技术就是让我们更加高效轻松地将任何应用在</strong>Linux<strong>服务器部署和使用</strong></p> <h3 id="【docker安装】"><a href="#【docker安装】" class="header-anchor">#</a> 【Docker安装】</h3> <p>1）卸载旧版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum list installed <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">docker</span> <span class="token comment">#列出当前所有docker的包</span>
yum <span class="token parameter variable">-y</span> remove docker-*  <span class="token comment">#的包名称 卸载docker包</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/docker <span class="token comment">#删除docker的所有镜像和容器</span>
</code></pre></div><p>2）安装必要的软件包</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils  device-mapper-persistent-data  lvm2
</code></pre></div><p>3）设置下载的镜像仓库</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
<span class="token comment">#或使用加速镜像:  yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</code></pre></div><p>4）列出需要安装的版本列表</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum list docker-ce <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span>  
</code></pre></div><p>5）安装指定版本（这里使用18.0.1版本）</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce-18.06.1.ce
</code></pre></div><p>6）查看版本&amp;设置开机自启</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token parameter variable">-v</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span> <span class="token comment">#设置开机启动  </span>
systemctl is-enabled <span class="token function">docker</span>  <span class="token comment">#查看是否设置为开机自启</span>
</code></pre></div><p>7）启动Docker</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl start <span class="token function">docker</span> <span class="token comment">#启动</span>
</code></pre></div><p>8）添加阿里云镜像下载地址</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> /etc/docker/daemon.json
</code></pre></div><p>内容如下：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span> 
  <span class="token property">&quot;registry-mirrors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://zydiol88.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>9）重启Docker</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>  
systemctl status <span class="token function">docker</span>  <span class="token comment">#查看docker状态</span>
</code></pre></div><p>离线安装方式请参考：<a href="https://www.cnblogs.com/kingsonfu/p/11576797.html" title="https://www.cnblogs.com/kingsonfu/p/11576797.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/kingsonfu/p/11576797.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="【docker命令】"><a href="#【docker命令】" class="header-anchor">#</a> 【docker命令】</h3> <p>1）镜像命令：</p> <p>镜像：相当于应用的安装包，在Docker部署的任何应用都需要先构建成为镜像</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> search 镜像名称 <span class="token comment">#搜索镜像</span>
<span class="token function">docker</span> pull 镜像名称 <span class="token comment">#拉取镜像 示例：docker pull nginx</span>
<span class="token function">docker</span> images <span class="token comment">#查看本地所有镜像</span>
<span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> 镜像名称 <span class="token comment">#删除镜像(即使在运行)</span>
<span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> images <span class="token parameter variable">-qa</span><span class="token variable">)</span></span> <span class="token comment">#删除所有镜像</span>
</code></pre></div><p>2）容器命令</p> <p>容器：容器是由镜像创建而来。容器是Docker运行应用的载体，每个应用都分别运行在Docker的每个
容器中。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">-p</span> 对应宿主机那个端口:开放应用端口  镜像名称:标签 <span class="token comment">#运行容器（默认是前台运行），di:i是运行，d是后台;  -p是public的意思;</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token comment">#查看运行的容器</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token comment">#查询所有容器</span>

<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 容器ID/容器名称 /bin/bash <span class="token comment">#进入容器内部</span>
<span class="token function">docker</span> start/stop/restart 容器名称/ID <span class="token comment">#启动/停止/重启容器</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> 容器名称/ID <span class="token comment">#删除容器</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-q</span><span class="token variable">`</span></span> <span class="token comment">#删除所有容器</span>
</code></pre></div><h3 id="【镜像的制作】"><a href="#【镜像的制作】" class="header-anchor">#</a> 【镜像的制作】</h3> <p>下面将 &quot;ttensquare_eureka_server-1.0-SNAPSHOT.jar&quot; enreka微服务制作成一个docker镜像</p> <p>1）上传Eureka的微服务jar包到linux
2）编写Dockerfile</p> <div class="language-bash extra-class"><pre class="language-bash"><code>FROM openjdk:8-jdk-alpine
ARG JAR_FILE
COPY <span class="token variable">${JAR_FILE}</span> app.jar
EXPOSE <span class="token number">10086</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">&quot;java&quot;</span>,<span class="token string">&quot;-jar&quot;</span>,<span class="token string">&quot;/app.jar&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>3）构建镜像</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> build --build-arg <span class="token assign-left variable">JAR_FILE</span><span class="token operator">=</span>tensquare_eureka_server-1.0-SNAPSHOT.jar <span class="token parameter variable">-t</span> eureka:v1 <span class="token builtin class-name">.</span>
</code></pre></div><p>4）查看镜像是否创建成功</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> images
</code></pre></div><p>5）创建容器</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-i</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>eureka <span class="token parameter variable">-p</span> <span class="token number">10086</span>:10086 eureka:v1
</code></pre></div><p>6）访问容器
<a href="http://192.168.66.101:10086" title="http://192.168.66.101:10086" target="_blank" rel="noopener noreferrer">http://192.168.66.101:10086<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="【harbor安装】"><a href="#【harbor安装】" class="header-anchor">#</a> 【Harbor安装】</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627212945189-1627212945174.png" alt=""></p> <p>简介：</p> <p>Harbor（港口，港湾）是一个用于存储和分发Docker镜像的企业级Registry服务器。
除了Harbor这个私有镜像仓库之外，还有Docker官方提供的Registry。相对Registry，Harbor具有很
多优势：</p> <ol><li><p>提供分层传输机制，优化网络传输 Docker镜像是是分层的，而如果每次传输都使用全量文件(所以
用FTP的方式并不适合)，显然不经济。必须提供识别分层传输的机制，以层的UUID为标识，确定
传输的对象。</p></li> <li><p>提供WEB界面，优化用户体验 只用镜像的名字来进行上传下载显然很不方便，需要有一个用户界
面可以支持登陆、搜索功能，包括区分公有、私有镜像。</p></li> <li><p>支持水平扩展集群 当有用户对镜像的上传下载操作集中在某服务器，需要对相应的访问压力作分
解。</p></li> <li><p>良好的安全机制 企业中的开发团队有很多不同的职位，对于不同的职位人员，分配不同的权限，
具有更好的安全性。</p></li></ol> <p>1）先安装Docker并启动Docker（已完成）</p> <p>参考之前的安装过程
2）先安装docker-compose</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">`</span></span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose  <span class="token comment">#安装</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose  
<span class="token function">docker-compose</span> <span class="token parameter variable">--version</span>  <span class="token comment">#查看版本</span>
</code></pre></div><p>3）下载Harbor的压缩包（本课程版本为：v1.9.2）
<a href="https://github.com/goharbor/harbor/releases" title="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener noreferrer">https://github.com/goharbor/harbor/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
4）上传压缩包到linux，并解压</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">tar</span> <span class="token parameter variable">-xzf</span> harbor-offline-installer-v1.9.2.tgz
<span class="token function">mkdir</span> /opt/harbor
<span class="token function">mv</span> harbor/* /opt/harbor
<span class="token builtin class-name">cd</span> /opt/harbor
</code></pre></div><p>5）修改Harbor的配置</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> harbor.yml
<span class="token comment">#修改内容1:   hostname: 192.168.66.102</span>
<span class="token comment">#修改内容2:   port: 85</span>
</code></pre></div><p>6）安装Harbor</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./prepare
./install.sh
</code></pre></div><p>7）启动Harbor</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> <span class="token comment">#启动</span>
<span class="token comment">#docker-compose down -v #停止</span>
</code></pre></div><p>8）访问Harbor
<a href="http://192.168.66.102:85" title="http://192.168.66.102:85" target="_blank" rel="noopener noreferrer">http://192.168.66.102:85<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
默认账户密码：admin/Harbor12345</p> <p>你可能会遇到的问题：<a href="https://www.cnblogs.com/hallejuayahaha/p/13926575.html" title="https://www.cnblogs.com/hallejuayahaha/p/13926575.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/hallejuayahaha/p/13926575.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> （参考）博主遇到了docker-compose过低找不到，导致启动报错：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>[root@localhost zhuangjie]# docker-compose up -d #启动
ERROR: 
        Can't find a suitable configuration file in this directory or any
        parent. Are you in the right directory?

        Supported filenames: docker-compose.yml, docker-compose.yaml
        
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#解决</span>
<span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">`</span></span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose
<span class="token function">docker-compose</span> <span class="token parameter variable">--version</span>

./install.sh <span class="token comment">#注意还要cd到Harbor根目录执行</span>
</code></pre></div><h3 id="【项目与用户】"><a href="#【项目与用户】" class="header-anchor">#</a> 【项目与用户】</h3> <p>登录后：</p> <p>1）创建私有项目（项目分为公开项目与私有项目）</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627218066729-1627218066687.png" alt=""></p> <p>2）创建用户</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217685972-1627217685963.png" alt=""></p> <p>3）为项目添加成员：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217922413-1627217922383.png" alt=""></p> <table><thead><tr><th>角色</th> <th>权限说明</th></tr></thead> <tbody><tr><td>访客</td> <td>对于指定项目拥有只读权限</td></tr> <tr><td>开发人员</td> <td>对于指定项目拥有读写权限</td></tr> <tr><td>维护人员</td> <td>对于指定项目拥有读写权限，创建 Webhooks</td></tr> <tr><td>项目管理员</td> <td>除了读写权限，同时拥有用户管理/镜像扫描等管理权限</td></tr></tbody></table> <h3 id="【推送镜像到harbor】"><a href="#【推送镜像到harbor】" class="header-anchor">#</a> 【推送镜像到Harbor】</h3> <p>1）给镜像打上标签</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> tag eureka:v1 <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1
</code></pre></div><p>2）推送镜像(会遇到二个问题，请解决)</p> <ol><li><p>问题1：需要把Harbor地址加入到Docker信任列表,不解决，推送会提示：
vi /etc/docker/daemon.json
需要重启Docker</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>The push refers to repository [192.168.66.102:85/tensquare/eureka]
Get https://192.168.66.102:85/v2/: http: server gave HTTP response to HTTPS
client
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span> 
 <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://zydiol88.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>,
 <span class="token string">&quot;insecure-registries&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;192.168.87.102:85&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>问题2：权限不足，不解决，推送会提示：“denied: requested access to the resource is denied”</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#docker login -u 用户名 -p 密码 192.168.87.102:85</span>

<span class="token punctuation">[</span>root@localhost 桌面<span class="token punctuation">]</span><span class="token comment"># docker login -u zhuangjie  -p gkmzjaznH21  192.168.87.102:85</span>
Login Succeeded
</code></pre></div></li> <li><p>推送</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> push <span class="token number">192.168</span>.208.157:85/uplog/eureka
</code></pre></div></li></ol> <p>3）登录Harbor查看</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627219857216-1627219857185.png" alt=""></p> <h3 id="【从harbor拉取镜像】"><a href="#【从harbor拉取镜像】" class="header-anchor">#</a> 【从Harbor拉取镜像】</h3> <p>存在Docker后，我们做以下准备，这样才能确保我们能从Harbor中拉取镜像：</p> <ol><li><p>需要把Harbor地址加入到Docker信任列表,不解决，推送会提示：
vi /etc/docker/daemon.json
需要重启Docker</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>The push refers to repository [192.168.66.102:85/tensquare/eureka]
Get https://192.168.66.102:85/v2/: http: server gave HTTP response to HTTPS
client
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span> 
 <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://zydiol88.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>,
 <span class="token string">&quot;insecure-registries&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;192.168.208.157:85&quot;</span><span class="token punctuation">]</span>  
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>准备拉取</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> login <span class="token parameter variable">-u</span> zhuangjie <span class="token parameter variable">-p</span> zhuangJIE3333 <span class="token number">192.168</span>.208.157:85  <span class="token comment">#登录</span>
<span class="token function">docker</span> pull <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1  <span class="token comment">#拉取，该拉取命令直接从Harbor上一键复制</span>
<span class="token function">docker</span> images  <span class="token comment">#查看本地镜像</span>
</code></pre></div></li></ol> <h2 id="【微服务持续集成】"><a href="#【微服务持续集成】" class="header-anchor">#</a> 【微服务持续集成】</h2> <h3 id="【将代码上传到gitlab】"><a href="#【将代码上传到gitlab】" class="header-anchor">#</a> 【将代码上传到GitLab】</h3> <p>后端代码：注意要代码要添加打包的插件</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>前端代码：</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm run dev  <span class="token comment">#测试启动项目</span>
</code></pre></div><p>在GitLab上分别创建两个项目，分别是前端的 <strong>tensquare_front</strong>  与后端的 <strong>tensquare_back</strong>  ，然后将代码分别上传到对应的项目仓库上去。</p> <h3 id="【jenkins拉取与构建】"><a href="#【jenkins拉取与构建】" class="header-anchor">#</a> 【Jenkins拉取与构建】</h3> <p>在jenkins上创建一个流水线的项目 “tensquare_back”  ，项目使用参数化（字符参数）构建：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627527217960-1627527217853.png" alt=""></p> <p>使用本地脚本进行构建：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627527398196-1627527398130.png" alt=""></p> <p>项目根目录“Jenkinsfile” 脚本文件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">&quot;3b3eca2f-e2d7-44e5-8e11-e98ee29953dc&quot;</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">&quot;git@192.168.87.128:zhuangjie/tensquare_back.git&quot;</span>
node <span class="token punctuation">{</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">&quot;*/${branch}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">doGenerateSubmoduleConfigurations</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">submoduleCfg</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">userRemoteConfigs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">&quot;${git_auth}&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;${git_url}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后进行构建！</p> <h3 id="【加入代码审查】"><a href="#【加入代码审查】" class="header-anchor">#</a> 【加入代码审查】</h3> <p>在jenkins中加入一个构建参数（选项参数）：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627542931380-1627542931219.png" alt=""></p> <p>在项目代码中，编辑“Jenkinsfile” 文件加入代码审查的脚本代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//git凭证ID(ssh)</span>
def git_auth <span class="token operator">=</span> <span class="token string">&quot;3b3eca2f-e2d7-44e5-8e11-e98ee29953dc&quot;</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">&quot;git@192.168.87.128:zhuangjie/tensquare_back.git&quot;</span>
node <span class="token punctuation">{</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">&quot;*/${branch}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">doGenerateSubmoduleConfigurations</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">submoduleCfg</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">userRemoteConfigs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">&quot;${git_auth}&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;${git_url}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//jenkins&gt;系统管理&gt;全局工具配置&gt;SonarQube Scanner&gt;&quot;Name&quot;</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//jenkins&gt;系统管理&gt;系统配置&gt;SonarQube servers&gt;&quot;Name&quot;</span>
                sh <span class="token string">&quot;&quot;</span>&quot;
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">&quot;&quot;</span>&quot;
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时我们在每个微服务模块的根目录下加入“sonar-project.properties”  文件(注意模块间的该文件内容是不同的)：</p> <p>tensquare_eureka_server模块：</p> <div class="language-.properties extra-class"><pre class="language-text"><code># must be unique in a given SonarQube instance
sonar.projectKey=tensquare_eureka_server
# this is the name and version displayed in the SonarQube UI. Was mandatory prior to SonarQube 6.1.
sonar.projectName=tensquare_eureka_server
sonar.projectVersion=1.0

# Path is relative to the sonar-project.properties file. Replace &quot;\&quot; by &quot;/&quot; on Windows.
# This property is optional if sonar.modules is set.
sonar.sources=.
sonar.exclusions=**/test/**,**/target/**
sonar.java.binaries=.

sonar.java.source=1.8
sonar.java.target=1.8
#sonar.java.libraries=**/target/classes/**

# Encoding of the source code. Default is default system encoding
sonar.sourceEncoding=UTF-8
</code></pre></div><p>tensquare_zuul模块：</p> <div class="language-.properties extra-class"><pre class="language-text"><code># must be unique in a given SonarQube instance
sonar.projectKey=tensquare_zuul
# this is the name and version displayed in the SonarQube UI. Was mandatory prior to SonarQube 6.1.
sonar.projectName=tensquare_zuul
sonar.projectVersion=1.0

# Path is relative to the sonar-project.properties file. Replace &quot;\&quot; by &quot;/&quot; on Windows.
# This property is optional if sonar.modules is set.
sonar.sources=.
sonar.exclusions=**/test/**,**/target/**
sonar.java.binaries=.

sonar.java.source=1.8
sonar.java.target=1.8
#sonar.java.libraries=**/target/classes/**

# Encoding of the source code. Default is default system encoding
sonar.sourceEncoding=UTF-8
</code></pre></div><p>其它模块也是一样。然后进行代码构建，构建完后，我们可以访问Sonar来查看审查结果。</p> <h3 id="【编译打包】"><a href="#【编译打包】" class="header-anchor">#</a> 【编译打包】</h3> <p>我们需要将公共依赖进行安装，所以需要编辑项目根目录下 “Jenkinsfile”  脚本,加入“编译，安装公共子工程” 这个 阶段：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">&quot;3b3eca2f-e2d7-44e5-8e11-e98ee29953dc&quot;</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">&quot;git@192.168.87.133:zhuangjie/tensquare_back.git&quot;</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">&quot;*/${branch}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">doGenerateSubmoduleConfigurations</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">submoduleCfg</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">userRemoteConfigs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">&quot;${git_auth}&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;${git_url}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">&quot;&quot;</span>&quot;
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">&quot;&quot;</span>&quot;
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">&quot;mvn -f tensquare_common clean install&quot;</span>
   <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>然后在确保各个模块&quot;pom.xml&quot; 存在打包插件(父工程的该插件可以删除了)：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这样就能确保依赖安装能完成了。下面我们就进行对可运行的微服务进行打包：</p> <p>编辑项目根目录下 “Jenkinsfile”  脚本,加入“编译，打包微服务工程” 这个 阶段：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">&quot;3b3eca2f-e2d7-44e5-8e11-e98ee29953dc&quot;</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">&quot;git@192.168.87.133:zhuangjie/tensquare_back.git&quot;</span>


node <span class="token punctuation">{</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">&quot;*/${branch}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">doGenerateSubmoduleConfigurations</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">submoduleCfg</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">userRemoteConfigs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">&quot;${git_auth}&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;${git_url}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">&quot;&quot;</span>&quot;
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">&quot;&quot;</span>&quot;
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">&quot;mvn -f tensquare_common clean install&quot;</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">&quot;mvn -f ${project_name}  clean package&quot;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>因为zull这个模块时依赖了父模块，所以我们需要确保服务器的本地仓库有父工程：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/root/.m2/repository/com/tensquare
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># mv /home/zhuangjie/桌面/tensquare_parent/ ./</span>
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># ll</span>
drwxr-xr-x. <span class="token number">3</span> root      root      <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:18 tensquare_common
drwxrwxrwx. <span class="token number">3</span> zhuangjie zhuangjie <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:37 tensquare_parent
</code></pre></div><p>我们移动的文件目录：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549375224-1627549375170.png" alt=""></p> <p>然后再进行构建。这样我们在拉取的代码目录中就打包好了该模块的jar文件（测试jar可正常运行）。</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549978651-1627549978565.png" alt=""></p> <h3 id="【镜像制作】"><a href="#【镜像制作】" class="header-anchor">#</a> 【镜像制作】</h3> <p>在每个模块中加入“Dockerfile” 文件（common不需要)：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#FROM java:8</span>
FROM openjdk:8-jdk-alpine
ARG JAR_FILE
COPY <span class="token variable">${JAR_FILE}</span> app.jar
EXPOSE <span class="token number">10020</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">&quot;java&quot;</span>,<span class="token string">&quot;-jar&quot;</span>,<span class="token string">&quot;/app.jar&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>在模块pom.xml中加入插件(common不需要)：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.spotify<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dockerfile-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>${project.artifactId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>buildArgs</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>JAR_FILE</span><span class="token punctuation">&gt;</span></span>target/${project.build.finalName}.jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>JAR_FILE</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>buildArgs</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后编辑 “Jenkinsfile” (加入：<strong>dockerfile:build</strong> 来触发制作镜像)：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">&quot;3b3eca2f-e2d7-44e5-8e11-e98ee29953dc&quot;</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">&quot;git@192.168.87.133:zhuangjie/tensquare_back.git&quot;</span>

node <span class="token punctuation">{</span>
    
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">&quot;*/${branch}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">doGenerateSubmoduleConfigurations</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">submoduleCfg</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">userRemoteConfigs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">&quot;${git_auth}&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;${git_url}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">&quot;&quot;</span>&quot;
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">&quot;&quot;</span>&quot;
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">&quot;mvn -f tensquare_common clean install&quot;</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">&quot;mvn -f ${project_name}  clean package dockerfile:build&quot;</span>
   <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>然后在jenkins点击构建。完成后：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> images  <span class="token comment">#查看镜像，就会发现多出一个镜像文件，查看时间是刚刚制作的</span>
</code></pre></div><h3 id="【应用部署】"><a href="#【应用部署】" class="header-anchor">#</a> 【应用部署】</h3> <p>以下步骤：</p> <p>1）在jenkins安装 Publish Over SSH插件</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628080915258-1628080915249.png" alt=""></p> <p>2）确保jenkins（101）服务器有.ssh如果没有使用命令 &quot;ssh-keygen&quot; 生成。然后使用命令 &quot;ssh-copy-id 192.168.87.103&quot; 将公钥copy到web（103）服务器中</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628082119907-1628082119768.png" alt=""></p> <p>3）在jenkins 的”全局配置“中配置&quot;Publish over SSH&quot; 的内容。怎么配置？</p> <p>【Passphrse】密码，好像没有设置，如果设置了，需要填写。
【Path to key】key文件的路径（私钥）/root/.ssh/id_rsa
【Key】为空，也 可以测试成功**。注意如果 “/root/.ssh/id_rsa” 文件找不到需要将.ssh的私钥粘贴到文本框中，至于是root还是其它用户，要看使用copy命令时用的是哪个用户执行的了。**</p> <p>【SSH Server Name】标识的名字，随便你取什么名字
【Hostname】需要连接ssh的主机名或ip地址，此处填写应用服务器IP（建议ip）
【Username】用户名
【Remote Directory】远程目录(根据需要填写文件传到此目录下)
【Test Configuration】配置完成，点击test会显示Success![]</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093028483-1628093028472.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628083784632-1628083784445.png" alt=""></p> <p>4）在jenkins项目配置中添加一个&quot;字符参数&quot; + 在项目代码中修改 &quot;Jenkinsfile&quot; 文件 + 上传部署脚本到web服务器中（需要授于执行权限 chmod +x deploy.sh ）</p> <p>steps1:</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093531296-1628093531286.png" alt=""></p> <p>steps2:  加入“应用部署”</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>//git凭证ID
def git_auth = &quot;da1d1333-c35f-415a-903c-b8d58c870c56&quot;
//git的url地址
def git_url = &quot;git@192.168.87.100:zhuangjie/tensquare_back.git&quot;

//镜像的版本号
def tag = &quot;latest&quot;
//Harbor的url地址
def harbor_url = &quot;192.168.87.102:85&quot;
//镜像库项目名称
def harbor_project = &quot;uplog&quot;
//Harbor的登录凭证ID
def harbor_auth = &quot;ef2651c8-92a7-4edb-b4ca-4e182fadf0ca&quot;

node {
//    //获取当前选择的项目名称
//    def selectedProjectNames = &quot;${project_name}&quot;.split(&quot;,&quot;)
//    //获取当前选择的服务器名称
//    def selectedServers = &quot;${publish_server}&quot;.split(&quot;,&quot;)

   stage('拉取代码') {
      checkout([$class: 'GitSCM', branches: [[name: &quot;*/${branch}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &quot;${git_auth}&quot;, url: &quot;${git_url}&quot;]]])
   }
   stage('代码审查') {
        def scannerHome=tool 'SonarQube-Scanner'//根据自己的Jenkinssonarqube-scanner环境修改
        withSonarQubeEnv('SonarQube6.7'){ //引入Jenkinssonarqube环境
                sh &quot;&quot;&quot;
    cd ${project_name}
    ${scannerHome}/bin/sonar-scanner
  &quot;&quot;&quot;
        }


   }
   stage('编译，安装公共子工程') {
     sh &quot;mvn -f tensquare_common clean install&quot;
   }
   stage('编译，打包微服务工程，上传镜像') {
   sh &quot;echo '开始制作镜像'&quot;
     sh &quot;mvn -f ${project_name}  clean package dockerfile:build&quot;
    sh &quot;echo '镜像制作好了'&quot;
      //定义镜像名称
                    def imageName = &quot;${project_name}:${tag}&quot;
                   //对镜像打上标签
                   sh &quot;docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}&quot;
                   //把镜像推送到Harbor
               withCredentials([usernamePassword(credentialsId: &quot;${harbor_auth}&quot;, passwordVariable: 'password', usernameVariable: 'username')]) {

                       //登录到Harbor
                       sh &quot;docker login -u ${username} -p ${password} ${harbor_url}&quot;
                       //镜像上传
                       sh &quot;docker push ${harbor_url}/${harbor_project}/${imageName}&quot;
                       sh &quot;echo 镜像上传成功&quot;
              }
              sh &quot;echo '应用部署开始'&quot;
                sshPublisher(publishers: [
                            sshPublisherDesc(configName: 'master_server',
                            transfers: [
                                sshTransfer(cleanRemote: false,
                                excludes: '',
                                // 触发的命令，deploy.sh
                                execCommand: &quot;/opt/jenkins_shell/deploy.sh $harbor_url $harbor_project $project_name $tag $port&quot;,
                                execTimeout: 120000,
                                flatten: false,
                                makeEmptyDirs: false,
                                noDefaultExcludes: false,
                                patternSeparator: '[ , ]+',
                                remoteDirectory: '',
                                remoteDirectorySDF: false,
                                removePrefix: '',
                                sourceFiles: '')
                            ],
                            usePromotionTimestamp: false,
                            useWorkspaceInPromotion: false,
                            verbose: false)
                ])
                sh &quot;echo '应用部署结束'&quot;
   }

}
</code></pre></div><p>与之前相比添加了：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>....

sh &quot;echo '应用部署开始'&quot;
                sshPublisher(publishers: [
                            sshPublisherDesc(configName: 'master_server',
                            transfers: [
                                sshTransfer(cleanRemote: false,
                                excludes: '',
                                // 触发的命令，deploy.sh
                                execCommand: &quot;/opt/jenkins_shell/deploy.sh $harbor_url $harbor_project $project_name $tag $port&quot;,
                                execTimeout: 120000,
                                flatten: false,
                                makeEmptyDirs: false,
                                noDefaultExcludes: false,
                                patternSeparator: '[ , ]+',
                                remoteDirectory: '',
                                remoteDirectorySDF: false,
                                removePrefix: '',
                                sourceFiles: '')
                            ],
                            usePromotionTimestamp: false,
                            useWorkspaceInPromotion: false,
                            verbose: false)
                ])
                sh &quot;echo '应用部署结束'&quot;
                
....
</code></pre></div><p>5）上传部署脚本到指定目录下（上面的Jenkinsfile部署代码中指定的路径）</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628085614649-1628085614604.png" alt=""></p> <p>注意：需要确保我们jenkins（101服务器）与web（103）服务器能正常登录Harbor（102）服务器</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628094317092-1628094317018.png" alt=""></p> <p>6）执行部署</p> <p>在web(103)服务器中，执行“docker ps -a”命令就会发现我们构建的项目正在运行：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093983955-1628093983885.png" alt=""></p> <p>访问：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628094028736-1628094028724.png" alt=""></p> <h2 id="【后端代码部署优化】"><a href="#【后端代码部署优化】" class="header-anchor">#</a> 【后端代码部署优化】</h2> <h3 id="【代码的修改】"><a href="#【代码的修改】" class="header-anchor">#</a> 【代码的修改】</h3> <p>主要是注册中心，其它微服务模块的修改是一样的。</p> <ul><li>Eureka 的 application.yml：</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 集群版</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> EUREKA<span class="token punctuation">-</span>HA

<span class="token punctuation">---</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># 指定profile=eureka-server1</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server1
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 指定当profile=eureka-server1时，主机名是eureka-server1</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 192.168.87.103
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
     <span class="token comment"># 将自己注册到eureka-server1、eureka-server2这个Eureka上面去</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.87.103<span class="token punctuation">:</span>10086/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//192.168.87.104<span class="token punctuation">:</span>10086/eureka/

<span class="token punctuation">---</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server2
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 192.168.87.104
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.87.103<span class="token punctuation">:</span>10086/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//192.168.87.104<span class="token punctuation">:</span>10086/eureka/
</code></pre></div><p>在启动微服务的时候，加入参数: spring.profiles.active 来读取对应的配置，使不同的机器应用不同的配置。</p> <ul><li>除了Eureka注册中心以外，其他微服务配置都需要加入所有Eureka服务</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># Eureka配置</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.87.103<span class="token punctuation">:</span>10086/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//192.168.87.104<span class="token punctuation">:</span>10086/eureka/ <span class="token comment"># Eureka访问地址</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><h3 id="【jenkins中创建项目】"><a href="#【jenkins中创建项目】" class="header-anchor">#</a> 【jenkins中创建项目】</h3> <p>创建一个名为 &quot;tensquare_back_cluster&quot; 的流水线项目，并</p> <p>进行参数化构建：</p> <p>tensquare_eureka_server@10086,tensquare_zuul@10020,tensquare_admin_service@9001,tensquare_gathering@9002</p> <p>注册中心,服务网关,权限服务,活动服务</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628517339350-1628517339044.png" alt=""></p> <p>此时的构建效果：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628517441217-1628517441081.png" alt=""></p> <h3 id="【代码审查】"><a href="#【代码审查】" class="header-anchor">#</a> 【代码审查】</h3> <p>修改项目“<strong>Jenkinsfile</strong>” 文件</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628521417094-1628521416987-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90todo.png" alt=""></p> <p>此时的完整Jenkinsfile内容：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>//git凭证ID
def git_auth = &quot;da1d1333-c35f-415a-903c-b8d58c870c56&quot;
//git的url地址
def git_url = &quot;git@192.168.87.100:zhuangjie/tensquare_back.git&quot;

//镜像的版本号
def tag = &quot;latest&quot;
//Harbor的url地址
def harbor_url = &quot;192.168.87.102:85&quot;
//镜像库项目名称
def harbor_project = &quot;uplog&quot;
//Harbor的登录凭证ID
def harbor_auth = &quot;ef2651c8-92a7-4edb-b4ca-4e182fadf0ca&quot;

node {
    //获取当前选择的项目名称
    def selectedProjectNames = &quot;${project_name}&quot;.split(&quot;,&quot;)


   stage('拉取代码') {
      checkout([$class: 'GitSCM', branches: [[name: &quot;*/${branch}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &quot;${git_auth}&quot;, url: &quot;${git_url}&quot;]]])
   }
   stage('代码审查') {
        for (int i=0; i&lt;selectedProjectNames.length; i++) {
            //tensquare_eureka_server@10086
            def projectInfo = selectedProjectNames[i];
            //当前遍历的项目名称
            def currentProjectName = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[0]
            //当前遍历的项目端口
            def currentProjectPort = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[1]
            def scannerHome=tool 'SonarQube-Scanner'//根据自己的Jenkinssonarqube-scanner环境修改
            withSonarQubeEnv('SonarQube6.7'){ //引入Jenkinssonarqube环境
                sh &quot;&quot;&quot;
                cd ${currentProjectName}
                ${scannerHome}/bin/sonar-scanner
              &quot;&quot;&quot;
            }

        }


   }
   stage('编译，安装公共子工程') {
     sh &quot;mvn -f tensquare_common clean install&quot;
   }
   stage('编译，打包微服务工程，上传镜像') {
   sh &quot;echo '开始制作镜像'&quot;
     sh &quot;mvn -f ${project_name}  clean package dockerfile:build&quot;
    sh &quot;echo '镜像制作好了'&quot;
      //定义镜像名称
                    def imageName = &quot;${project_name}:${tag}&quot;
                   //对镜像打上标签
                   sh &quot;docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}&quot;
                   //把镜像推送到Harbor
               withCredentials([usernamePassword(credentialsId: &quot;${harbor_auth}&quot;, passwordVariable: 'password', usernameVariable: 'username')]) {

                       //登录到Harbor
                       sh &quot;docker login -u ${username} -p ${password} ${harbor_url}&quot;
                       //镜像上传
                       sh &quot;docker push ${harbor_url}/${harbor_project}/${imageName}&quot;
                       sh &quot;echo 镜像上传成功&quot;
              }
              sh &quot;echo '应用部署开始'&quot;
                sshPublisher(publishers: [
                            sshPublisherDesc(configName: 'master_server',
                            transfers: [
                                sshTransfer(cleanRemote: false,
                                excludes: '',
                                // 触发的命令，deploy.sh
                                execCommand: &quot;/opt/jenkins_shell/deploy.sh $harbor_url $harbor_project $project_name $tag $port&quot;,
                                execTimeout: 120000,
                                flatten: false,
                                makeEmptyDirs: false,
                                noDefaultExcludes: false,
                                patternSeparator: '[ , ]+',
                                remoteDirectory: '',
                                remoteDirectorySDF: false,
                                removePrefix: '',
                                sourceFiles: '')
                            ],
                            usePromotionTimestamp: false,
                            useWorkspaceInPromotion: false,
                            verbose: false)
                ])
                sh &quot;echo '应用部署结束'&quot;
   }

}
</code></pre></div><h3 id="【上传镜像到harbor】"><a href="#【上传镜像到harbor】" class="header-anchor">#</a> 【上传镜像到Harbor】</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648447700-1628648447686-image-20210810234710355.png" alt=""></p> <p>如果想要构建成功还需要修改jenkinsfile“应用部署“中的（项目名称与端口）：</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code> ....
execCommand: &quot;/opt/jenkins_shell/deployCluster.sh $harbor_url $harbor_project $currentProjectName $tag $currentProjectPort&quot;,
 ....
</code></pre></div><h3 id="【应用部署】-2"><a href="#【应用部署】-2" class="header-anchor">#</a> 【应用部署】</h3> <p>分布式应用部署，我们需要再加入一台web服务器：</p> <p>1）需要在jenkins服务器中执行  ssh-copy-id 192.168.66.104 到新的web的服务器</p> <p>2）在新的web服务器中： vi /etc/docker/daemon.json</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628605176931-1628605176910.png" alt=""></p> <p>3）系统配置-&gt;添加远程服务器</p> <p>在jenkins（Publish over SSH）中配置一台web服务器</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628611001560-1628611001547.png" alt=""></p> <ol><li>修改流水线项目</li></ol> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648405698-1628648405683-image-20210811001519165.png" alt=""></p> <p>部署效果：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648388613-1628648388594-image-20210811002247011.png" alt=""></p> <p>5）修改项目&quot;Jenkinsfile&quot; 文件配置：</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648377303-1628648377290-image-20210811001121364.png" alt=""></p> <p>完整”Jenkinsfile“:</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>//git凭证ID
def git_auth = &quot;da1d1333-c35f-415a-903c-b8d58c870c56&quot;
//git的url地址
def git_url = &quot;git@192.168.87.100:zhuangjie/tensquare_back.git&quot;

//镜像的版本号
def tag = &quot;latest&quot;
//Harbor的url地址
def harbor_url = &quot;192.168.87.102:85&quot;
//镜像库项目名称
def harbor_project = &quot;uplog&quot;
//Harbor的登录凭证ID
def harbor_auth = &quot;ef2651c8-92a7-4edb-b4ca-4e182fadf0ca&quot;

node {
    //获取当前选择的项目名称
    def selectedProjectNames = &quot;${project_name}&quot;.split(&quot;,&quot;)
    //把选择的服务器信息转为数组
    def selectedServers = &quot;${publish_server}&quot;.split(',')

   stage('拉取代码') {
      checkout([$class: 'GitSCM', branches: [[name: &quot;*/${branch}&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &quot;${git_auth}&quot;, url: &quot;${git_url}&quot;]]])
   }
   stage('代码审查') {
        for (int i=0; i&lt;selectedProjectNames.length; i++) {
            //tensquare_eureka_server@10086
            def projectInfo = selectedProjectNames[i];
            //当前遍历的项目名称
            def currentProjectName = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[0]
            //当前遍历的项目端口
            def currentProjectPort = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[1]
            def scannerHome=tool 'SonarQube-Scanner'//根据自己的Jenkinssonarqube-scanner环境修改
            withSonarQubeEnv('SonarQube6.7'){ //引入Jenkinssonarqube环境
                sh &quot;&quot;&quot;
                cd ${currentProjectName}
                ${scannerHome}/bin/sonar-scanner
              &quot;&quot;&quot;
            }

        }


   }
   stage('编译，安装公共子工程') {
     sh &quot;mvn -f tensquare_common clean install&quot;
   }
   stage('编译，打包微服务工程，上传镜像') {
        for (int i=0; i&lt;selectedProjectNames.length; i++) {
            //tensquare_eureka_server@10086
            def projectInfo = selectedProjectNames[i];
            //当前遍历的项目名称
            def currentProjectName = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[0]
            //当前遍历的项目端口
            def currentProjectPort = &quot;${projectInfo}&quot;.split(&quot;@&quot;)[1]
            sh &quot;echo '开始制作镜像'&quot;
            sh &quot;mvn -f ${currentProjectName}  clean package dockerfile:build&quot;
            sh &quot;echo '镜像制作好了'&quot;
            //定义镜像名称
            def imageName = &quot;${currentProjectName}:${tag}&quot;
            //对镜像打上标签
            sh &quot;docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}&quot;
            //把镜像推送到Harbor
            withCredentials([usernamePassword(credentialsId: &quot;${harbor_auth}&quot;, passwordVariable: 'password', usernameVariable: 'username')]) {
                    //登录到Harbor
                    sh &quot;docker login -u ${username} -p ${password} ${harbor_url}&quot;
                    //镜像上传
                    sh &quot;docker push ${harbor_url}/${harbor_project}/${imageName}&quot;
                    sh &quot;echo 镜像上传成功&quot;
            }
           //=====以下为远程调用进行项目部署========
           for(int j=0; j&lt;selectedServers.size(); j++){
               //每个服务名称
               def currentServer = selectedServers[j]
               //添加微服务运行时的参数：spring.profiles.active
               def activeProfile = &quot;--spring.profiles.active=&quot;
               if(currentServer==&quot;master_server&quot;){
                    activeProfile = activeProfile+&quot;eureka-server1&quot;
               }else if(currentServer==&quot;slave_server1&quot;){
                    activeProfile = activeProfile+&quot;eureka-server2&quot;
               }
                sh &quot;echo '应用部署开始'&quot;
                sshPublisher(publishers: [
                       sshPublisherDesc(configName: &quot;${currentServer}&quot;,
                       transfers: [
                           sshTransfer(cleanRemote: false,
                           excludes: '',
                           // 触发的命令，deploy.sh
                           execCommand: &quot;/opt/jenkins_shell/deployCluster.sh $harbor_url $harbor_project $currentProjectName $tag $currentProjectPort&quot;,
                           execTimeout: 120000,
                           flatten: false,
                           makeEmptyDirs: false,
                           noDefaultExcludes: false,
                           patternSeparator: '[ , ]+',
                           remoteDirectory: '',
                           remoteDirectorySDF: false,
                           removePrefix: '',
                           sourceFiles: '')
                       ],
                       usePromotionTimestamp: false,
                       useWorkspaceInPromotion: false,
                       verbose: false)
                ])
                sh &quot;echo '应用部署结束'&quot;
            }
        }
   }

}
</code></pre></div><p>6）在两个生产服务器中 &quot;/opt/jenkins_shell&quot; 目录下加入 &quot;deployCluster.sh&quot; 脚本，并授予执行权限；</p> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648361824-1628648361791-image-20210811001811353.png" alt=""></p> <p>deployCluster.sh</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#! /bin/sh</span>
<span class="token comment">#接收外部参数</span>
<span class="token assign-left variable">harbor_url</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">harbor_project_name</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">project_name</span><span class="token operator">=</span><span class="token variable">$3</span>
<span class="token assign-left variable">tag</span><span class="token operator">=</span><span class="token variable">$4</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$5</span>
<span class="token assign-left variable">profile</span><span class="token operator">=</span><span class="token variable">$6</span>

<span class="token assign-left variable">imageName</span><span class="token operator">=</span><span class="token variable">$harbor_url</span>/<span class="token variable">$harbor_project_name</span>/<span class="token variable">$project_name</span><span class="token builtin class-name">:</span><span class="token variable">$tag</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$imageName</span>&quot;</span>

<span class="token comment">#查询容器是否存在，存在则删除</span>
<span class="token assign-left variable">containerId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-w</span> $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>:$<span class="token punctuation">{</span>tag<span class="token punctuation">}</span>  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$containerId</span>&quot;</span> <span class="token operator">!=</span>  <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token comment">#停掉容器</span>
    <span class="token function">docker</span> stop <span class="token variable">$containerId</span>

    <span class="token comment">#删除容器</span>
    <span class="token function">docker</span> <span class="token function">rm</span> <span class="token variable">$containerId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;成功删除容器&quot;</span>
<span class="token keyword">fi</span>

<span class="token comment">#查询镜像是否存在，存在则删除</span>
<span class="token assign-left variable">imageId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> images <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-w</span> $project_name  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $3}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$imageId</span>&quot;</span> <span class="token operator">!=</span>  <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
      
    <span class="token comment">#删除镜像</span>
    <span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> <span class="token variable">$imageId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;成功删除镜像&quot;</span>
<span class="token keyword">fi</span>


<span class="token comment"># 登录Harbor</span>
<span class="token function">docker</span> login <span class="token parameter variable">-u</span> zhuangjie <span class="token parameter variable">-p</span> gkmzjaznH21 <span class="token variable">$harbor_url</span>

<span class="token comment"># 下载镜像</span>
<span class="token function">docker</span> pull <span class="token variable">$imageName</span>

<span class="token comment"># 启动容器</span>
<span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">-p</span> <span class="token variable">$port</span><span class="token builtin class-name">:</span><span class="token variable">$port</span> <span class="token variable">$imageName</span> <span class="token variable">$profile</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;容器启动成功&quot;</span>
</code></pre></div><p>注意：需要修改 Harbor 登录信息。</p> <h3 id="【高可用的nginx】"><a href="#【高可用的nginx】" class="header-anchor">#</a> 【高可用的nginx】</h3> <p><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628686966488-1628686966378.png" alt=""></p> <p>1）安装Nginx（已完成）</p> <p>2）配置nginx</p> <div class="language-纯文本 extra-class"><pre class="language-text"><code>upstream zuulServer {
        server 192.168.87.103:10020 weight=1;
        server 192.168.87.104:10020 weight=1;
}
server {
        listen       9090;
        listen       [::]:80;
        server_name  _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
           proxy_pass http://zuulServer/;
    }
...

</code></pre></div><p>3）重启nginx</p> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl restart nginx
</code></pre></div><p><a href="/note/DevOps/Jenkins/Jenkins实战/Jenkins实战.html" title="Jenkins实战">Jenkins实战</a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2022年12月30日星期五下午4点40分</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.5c666aae.js" defer></script><script src="/assets/js/2.f4acce4e.js" defer></script><script src="/assets/js/9.757fe49c.js" defer></script>
  </body>
</html>
